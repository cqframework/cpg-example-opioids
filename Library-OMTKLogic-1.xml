<?xml version="1.0" encoding="UTF-8"?>
<library xmlns="urn:hl7-org:elm:r1" xmlns:t="urn:hl7-org:elm-types:r1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fhir="http://hl7.org/fhir" xmlns:qdm43="urn:healthit-gov:qdm:v4_3" xmlns:qdm53="urn:healthit-gov:qdm:v5_3" xmlns:a="urn:hl7-org:cql-annotations:r1">
   <annotation translatorOptions="EnableAnnotations,EnableLocators,DisableListDemotion,DisableListPromotion" signatureLevel="None" xsi:type="a:CqlToElmInfo"/>
   <annotation xsi:type="a:Annotation">
      <a:s r="647">
         <a:s>library OMTKLogic version '0.0.0'</a:s>
      </a:s>
   </annotation>
   <identifier id="OMTKLogic" system="http://cqframework.org/cpg-example-opioids" version="0.0.0"/>
   <schemaIdentifier id="urn:hl7-org:elm" version="r1"/>
   <usings>
      <def localIdentifier="System" uri="urn:hl7-org:elm-types:r1"/>
   </usings>
   <codeSystems>
      <def localId="1" locator="10:1-10:64" name="RxNorm" id="http://www.nlm.nih.gov/research/umls/rxnorm" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="1">
               <a:s>/*
This is a &quot;stub&quot; version of the OMTKLogic library that has no dependencies
on the OMTK data. It provides a workable version of the logic suitable for
example usage. For the full version of this library, see the CDC Opioid
 Prescribing Support Implementation Guide.
*/

codesystem RxNorm: 'http://www.nlm.nih.gov/research/umls/rxnorm'</a:s>
            </a:s>
         </annotation>
      </def>
   </codeSystems>
   <statements>
      <def localId="22" locator="23:1-30:5" name="ToUCUM" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="22">
               <a:s>/*
  Normalizes the input units to UCUM units

  Note guidance for UCUM presentation of medication units from SNOMED here:
  https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwjU3vLpicPTAhWFMGMKHRpOBUAQFggiMAA&amp;url=https%3A%2F%2Fconfluence.ihtsdotools.org%2Fdownload%2Fattachments%2F17859188%2FExpressing%2520Units%2520of%2520Measure%2520for%2520Medicinal%2520Products.doc%3Fapi%3Dv2&amp;usg=AFQjCNE5sboicqvJDUyXJ2im8VzBpgHE8A

  The values listed here are the only ones currently present in the OMTK data

  Based on the HL7 UCUM subset here:
  http://download.hl7.de/documents/ucum/ucumdata.html
*/
define function ToUCUM(unit String):
  </a:s>
               <a:s r="21">
                  <a:s r="21">
                     <a:s>case </a:s>
                     <a:s r="3">
                        <a:s>unit</a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="6">
                        <a:s>when </a:s>
                        <a:s r="4">
                           <a:s>'MG'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="5">
                           <a:s>'mg'</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="9">
                        <a:s>when </a:s>
                        <a:s r="7">
                           <a:s>'MG/ACTUAT'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="8">
                           <a:s>'mg/{actuat}'</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="12">
                        <a:s>when </a:s>
                        <a:s r="10">
                           <a:s>'MG/HR'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="11">
                           <a:s>'mg/h'</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="15">
                        <a:s>when </a:s>
                        <a:s r="13">
                           <a:s>'MG/ML'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="14">
                           <a:s>'mg/mL'</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    else </a:s>
                     <a:s r="20">
                        <a:s r="18">
                           <a:s r="16">
                              <a:s>'Error: unknown{'</a:s>
                           </a:s>
                           <a:s> + </a:s>
                           <a:s r="17">
                              <a:s>unit</a:s>
                           </a:s>
                        </a:s>
                        <a:s> + </a:s>
                        <a:s r="19">
                           <a:s>'}'</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
  end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="21" locator="24:3-30:5" xsi:type="Case">
            <comparand localId="3" locator="24:8-24:11" name="unit" xsi:type="OperandRef"/>
            <caseItem localId="6" locator="25:5-25:23">
               <when localId="4" locator="25:10-25:13" valueType="t:String" value="MG" xsi:type="Literal"/>
               <then localId="5" locator="25:20-25:23" valueType="t:String" value="mg" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="9" locator="26:5-26:39">
               <when localId="7" locator="26:10-26:20" valueType="t:String" value="MG/ACTUAT" xsi:type="Literal"/>
               <then localId="8" locator="26:27-26:39" valueType="t:String" value="mg/{actuat}" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="12" locator="27:5-27:28">
               <when localId="10" locator="27:10-27:16" valueType="t:String" value="MG/HR" xsi:type="Literal"/>
               <then localId="11" locator="27:23-27:28" valueType="t:String" value="mg/h" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="15" locator="28:5-28:29">
               <when localId="13" locator="28:10-28:16" valueType="t:String" value="MG/ML" xsi:type="Literal"/>
               <then localId="14" locator="28:23-28:29" valueType="t:String" value="mg/mL" xsi:type="Literal"/>
            </caseItem>
            <else localId="20" locator="29:10-29:39" xsi:type="Concatenate">
               <operand localId="18" locator="29:10-29:33" xsi:type="Concatenate">
                  <operand localId="16" locator="29:10-29:26" valueType="t:String" value="Error: unknown{" xsi:type="Literal"/>
                  <operand localId="17" locator="29:30-29:33" name="unit" xsi:type="OperandRef"/>
               </operand>
               <operand localId="19" locator="29:37-29:39" valueType="t:String" value="}" xsi:type="Literal"/>
            </else>
         </expression>
         <operand name="unit">
            <operandTypeSpecifier localId="2" locator="23:29-23:34" name="t:String" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="105" locator="35:1-45:5" name="ToDaily" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="105">
               <a:s>/*
  Calculates daily frequency given frequency within a period
*/
define function ToDaily(frequency Integer, period System.Quantity):
  </a:s>
               <a:s r="104">
                  <a:s r="104">
                     <a:s>case </a:s>
                     <a:s r="26">
                        <a:s r="25">
                           <a:s>period</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="26">
                           <a:s>unit</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="34">
                        <a:s>when </a:s>
                        <a:s r="27">
                           <a:s>'h'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="33">
                           <a:s r="28">
                              <a:s>frequency</a:s>
                           </a:s>
                           <a:s> * </a:s>
                           <a:s r="32">
                              <a:s>(</a:s>
                              <a:s r="32">
                                 <a:s r="29">24.0 / </a:s>
                                 <a:s r="31">
                                    <a:s r="30">
                                       <a:s>period</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="31">
                                       <a:s>value</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="44">
                        <a:s>when </a:s>
                        <a:s r="35">
                           <a:s>'min'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="43">
                           <a:s r="41">
                              <a:s r="36">
                                 <a:s>frequency</a:s>
                              </a:s>
                              <a:s> * </a:s>
                              <a:s r="40">
                                 <a:s>(</a:s>
                                 <a:s r="40">
                                    <a:s r="37">24.0 / </a:s>
                                    <a:s r="39">
                                       <a:s r="38">
                                          <a:s>period</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="39">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s r="42"> * 60</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="56">
                        <a:s>when </a:s>
                        <a:s r="45">
                           <a:s>'s'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="55">
                           <a:s r="53">
                              <a:s r="51">
                                 <a:s r="46">
                                    <a:s>frequency</a:s>
                                 </a:s>
                                 <a:s> * </a:s>
                                 <a:s r="50">
                                    <a:s>(</a:s>
                                    <a:s r="50">
                                       <a:s r="47">24.0 / </a:s>
                                       <a:s r="49">
                                          <a:s r="48">
                                             <a:s>period</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="49">
                                             <a:s>value</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                              </a:s>
                              <a:s r="52"> * 60</a:s>
                           </a:s>
                           <a:s r="54"> * 60</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="66">
                        <a:s>when </a:s>
                        <a:s r="57">
                           <a:s>'d'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="65">
                           <a:s r="63">
                              <a:s r="58">
                                 <a:s>frequency</a:s>
                              </a:s>
                              <a:s> * </a:s>
                              <a:s r="62">
                                 <a:s>(</a:s>
                                 <a:s r="62">
                                    <a:s r="59">24.0 / </a:s>
                                    <a:s r="61">
                                       <a:s r="60">
                                          <a:s>period</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="61">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s r="64"> / 24</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="78">
                        <a:s>when </a:s>
                        <a:s r="67">
                           <a:s>'wk'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="77">
                           <a:s r="73">
                              <a:s r="68">
                                 <a:s>frequency</a:s>
                              </a:s>
                              <a:s> * </a:s>
                              <a:s r="72">
                                 <a:s>(</a:s>
                                 <a:s r="72">
                                    <a:s r="69">24.0 / </a:s>
                                    <a:s r="71">
                                       <a:s r="70">
                                          <a:s>period</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="71">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s> / </a:s>
                           <a:s r="76">
                              <a:s>(</a:s>
                              <a:s r="76">
                                 <a:s r="74">24 * 7</a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="90">
                        <a:s>when </a:s>
                        <a:s r="79">
                           <a:s>'mo'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="89">
                           <a:s r="85">
                              <a:s r="80">
                                 <a:s>frequency</a:s>
                              </a:s>
                              <a:s> * </a:s>
                              <a:s r="84">
                                 <a:s>(</a:s>
                                 <a:s r="84">
                                    <a:s r="81">24.0 / </a:s>
                                    <a:s r="83">
                                       <a:s r="82">
                                          <a:s>period</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="83">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s> / </a:s>
                           <a:s r="88">
                              <a:s>(</a:s>
                              <a:s r="88">
                                 <a:s r="86">24 * 30</a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s> /* assuming 30 days in month */
    </a:s>
                     <a:s r="102">
                        <a:s>when </a:s>
                        <a:s r="91">
                           <a:s>'a'</a:s>
                        </a:s>
                        <a:s> then </a:s>
                        <a:s r="101">
                           <a:s r="97">
                              <a:s r="92">
                                 <a:s>frequency</a:s>
                              </a:s>
                              <a:s> * </a:s>
                              <a:s r="96">
                                 <a:s>(</a:s>
                                 <a:s r="96">
                                    <a:s r="93">24.0 / </a:s>
                                    <a:s r="95">
                                       <a:s r="94">
                                          <a:s>period</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="95">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s> / </a:s>
                           <a:s r="100">
                              <a:s>(</a:s>
                              <a:s r="100">
                                 <a:s r="98">24 * 365</a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s r="103"> /* assuming 365 days in year */
    else null
  end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="104" locator="36:3-45:5" xsi:type="Case">
            <comparand localId="26" locator="36:8-36:18" path="unit" xsi:type="Property">
               <source localId="25" locator="36:8-36:13" name="period" xsi:type="OperandRef"/>
            </comparand>
            <caseItem localId="34" locator="37:5-37:51">
               <when localId="27" locator="37:10-37:12" valueType="t:String" value="h" xsi:type="Literal"/>
               <then localId="33" locator="37:19-37:51" xsi:type="Multiply">
                  <operand xsi:type="ToDecimal">
                     <operand localId="28" locator="37:19-37:27" name="frequency" xsi:type="OperandRef"/>
                  </operand>
                  <operand localId="32" locator="37:31-37:51" xsi:type="Divide">
                     <operand localId="29" locator="37:32-37:35" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                     <operand localId="31" locator="37:39-37:50" path="value" xsi:type="Property">
                        <source localId="30" locator="37:39-37:44" name="period" xsi:type="OperandRef"/>
                     </operand>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="44" locator="38:5-38:58">
               <when localId="35" locator="38:10-38:14" valueType="t:String" value="min" xsi:type="Literal"/>
               <then localId="43" locator="38:21-38:58" xsi:type="Multiply">
                  <operand localId="41" locator="38:21-38:53" xsi:type="Multiply">
                     <operand xsi:type="ToDecimal">
                        <operand localId="36" locator="38:21-38:29" name="frequency" xsi:type="OperandRef"/>
                     </operand>
                     <operand localId="40" locator="38:33-38:53" xsi:type="Divide">
                        <operand localId="37" locator="38:34-38:37" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                        <operand localId="39" locator="38:41-38:52" path="value" xsi:type="Property">
                           <source localId="38" locator="38:41-38:46" name="period" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                  </operand>
                  <operand xsi:type="ToDecimal">
                     <operand localId="42" locator="38:57-38:58" valueType="t:Integer" value="60" xsi:type="Literal"/>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="56" locator="39:5-39:61">
               <when localId="45" locator="39:10-39:12" valueType="t:String" value="s" xsi:type="Literal"/>
               <then localId="55" locator="39:19-39:61" xsi:type="Multiply">
                  <operand localId="53" locator="39:19-39:56" xsi:type="Multiply">
                     <operand localId="51" locator="39:19-39:51" xsi:type="Multiply">
                        <operand xsi:type="ToDecimal">
                           <operand localId="46" locator="39:19-39:27" name="frequency" xsi:type="OperandRef"/>
                        </operand>
                        <operand localId="50" locator="39:31-39:51" xsi:type="Divide">
                           <operand localId="47" locator="39:32-39:35" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                           <operand localId="49" locator="39:39-39:50" path="value" xsi:type="Property">
                              <source localId="48" locator="39:39-39:44" name="period" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                     </operand>
                     <operand xsi:type="ToDecimal">
                        <operand localId="52" locator="39:55-39:56" valueType="t:Integer" value="60" xsi:type="Literal"/>
                     </operand>
                  </operand>
                  <operand xsi:type="ToDecimal">
                     <operand localId="54" locator="39:60-39:61" valueType="t:Integer" value="60" xsi:type="Literal"/>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="66" locator="40:5-40:56">
               <when localId="57" locator="40:10-40:12" valueType="t:String" value="d" xsi:type="Literal"/>
               <then localId="65" locator="40:19-40:56" xsi:type="Divide">
                  <operand localId="63" locator="40:19-40:51" xsi:type="Multiply">
                     <operand xsi:type="ToDecimal">
                        <operand localId="58" locator="40:19-40:27" name="frequency" xsi:type="OperandRef"/>
                     </operand>
                     <operand localId="62" locator="40:31-40:51" xsi:type="Divide">
                        <operand localId="59" locator="40:32-40:35" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                        <operand localId="61" locator="40:39-40:50" path="value" xsi:type="Property">
                           <source localId="60" locator="40:39-40:44" name="period" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                  </operand>
                  <operand xsi:type="ToDecimal">
                     <operand localId="64" locator="40:55-40:56" valueType="t:Integer" value="24" xsi:type="Literal"/>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="78" locator="41:5-41:63">
               <when localId="67" locator="41:10-41:13" valueType="t:String" value="wk" xsi:type="Literal"/>
               <then localId="77" locator="41:20-41:63" xsi:type="Divide">
                  <operand localId="73" locator="41:20-41:52" xsi:type="Multiply">
                     <operand xsi:type="ToDecimal">
                        <operand localId="68" locator="41:20-41:28" name="frequency" xsi:type="OperandRef"/>
                     </operand>
                     <operand localId="72" locator="41:32-41:52" xsi:type="Divide">
                        <operand localId="69" locator="41:33-41:36" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                        <operand localId="71" locator="41:40-41:51" path="value" xsi:type="Property">
                           <source localId="70" locator="41:40-41:45" name="period" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                  </operand>
                  <operand xsi:type="ToDecimal">
                     <operand localId="76" locator="41:56-41:63" xsi:type="Multiply">
                        <operand localId="74" locator="41:57-41:58" valueType="t:Integer" value="24" xsi:type="Literal"/>
                        <operand localId="75" locator="41:62" valueType="t:Integer" value="7" xsi:type="Literal"/>
                     </operand>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="90" locator="42:5-42:64">
               <when localId="79" locator="42:10-42:13" valueType="t:String" value="mo" xsi:type="Literal"/>
               <then localId="89" locator="42:20-42:64" xsi:type="Divide">
                  <operand localId="85" locator="42:20-42:52" xsi:type="Multiply">
                     <operand xsi:type="ToDecimal">
                        <operand localId="80" locator="42:20-42:28" name="frequency" xsi:type="OperandRef"/>
                     </operand>
                     <operand localId="84" locator="42:32-42:52" xsi:type="Divide">
                        <operand localId="81" locator="42:33-42:36" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                        <operand localId="83" locator="42:40-42:51" path="value" xsi:type="Property">
                           <source localId="82" locator="42:40-42:45" name="period" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                  </operand>
                  <operand xsi:type="ToDecimal">
                     <operand localId="88" locator="42:56-42:64" xsi:type="Multiply">
                        <operand localId="86" locator="42:57-42:58" valueType="t:Integer" value="24" xsi:type="Literal"/>
                        <operand localId="87" locator="42:62-42:63" valueType="t:Integer" value="30" xsi:type="Literal"/>
                     </operand>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="102" locator="43:5-43:64">
               <when localId="91" locator="43:10-43:12" valueType="t:String" value="a" xsi:type="Literal"/>
               <then localId="101" locator="43:19-43:64" xsi:type="Divide">
                  <operand localId="97" locator="43:19-43:51" xsi:type="Multiply">
                     <operand xsi:type="ToDecimal">
                        <operand localId="92" locator="43:19-43:27" name="frequency" xsi:type="OperandRef"/>
                     </operand>
                     <operand localId="96" locator="43:31-43:51" xsi:type="Divide">
                        <operand localId="93" locator="43:32-43:35" valueType="t:Decimal" value="24.0" xsi:type="Literal"/>
                        <operand localId="95" locator="43:39-43:50" path="value" xsi:type="Property">
                           <source localId="94" locator="43:39-43:44" name="period" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                  </operand>
                  <operand xsi:type="ToDecimal">
                     <operand localId="100" locator="43:55-43:64" xsi:type="Multiply">
                        <operand localId="98" locator="43:56-43:57" valueType="t:Integer" value="24" xsi:type="Literal"/>
                        <operand localId="99" locator="43:61-43:63" valueType="t:Integer" value="365" xsi:type="Literal"/>
                     </operand>
                  </operand>
               </then>
            </caseItem>
            <else asType="t:Decimal" xsi:type="As">
               <operand localId="103" locator="44:10-44:13" xsi:type="Null"/>
            </else>
         </expression>
         <operand name="frequency">
            <operandTypeSpecifier localId="23" locator="35:35-35:41" name="t:Integer" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="period">
            <operandTypeSpecifier localId="24" locator="35:51-35:65" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="112" locator="50:1-51:39" name="IsPatch" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="112">
               <a:s>/*
  Returns true if the given dose form is a patch (transdermal system)
*/
define function IsPatch(doseFormCode Code):
  </a:s>
               <a:s r="111">
                  <a:s r="111">
                     <a:s r="109">
                        <a:s>ToInteger(</a:s>
                        <a:s r="108">
                           <a:s r="107">
                              <a:s>doseFormCode</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="108">
                              <a:s>code</a:s>
                           </a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s r="110"> = 316987</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="111" locator="51:3-51:39" xsi:type="Equal">
            <operand localId="109" locator="51:3-51:30" xsi:type="ToInteger">
               <operand localId="108" locator="51:13-51:29" path="code" xsi:type="Property">
                  <source localId="107" locator="51:13-51:24" name="doseFormCode" xsi:type="OperandRef"/>
               </operand>
            </operand>
            <operand localId="110" locator="51:34-51:39" valueType="t:Integer" value="316987" xsi:type="Literal"/>
         </expression>
         <operand name="doseFormCode">
            <operandTypeSpecifier localId="106" locator="50:38-50:41" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="333" locator="86:1-154:5" name="GetConversionFactor" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="333">
               <a:s>/*
  Returns the conversion factor for the given ingredient

Opioid (strength in mg except where noted)	MME Conversion Factor*
Buprenorphine, transdermal patch (MCG/HR)	12.6
Buprenorphine, tablet or film	30
Buprenorphine, film (MCG)	0.03
Butorphanol	7
Codeine	0.15
Dihydrocodeine	0.25
Fentanyl, buccal/SL tabet or lozenge/troche (MCG)	0.13
Fentanyl, film or oral spray (MCG)	0.18
Fentanyl, nasal spray (MCG)	0.16
Fentanyl, transdermal patch (MCG/HR)	2.4
Hydrocodone	1
Hydromorphone	4
Levomethadyl acetate	8
Levorphanol tartrate	11
Meperidine 	0.1
Methadone	3
  1-20 mg/d 4
  21-40 mg/d 8
  41-60 mg/d 10
  61-80 mg/d 12
Morphine	1
Opium	1 // NOTE: Not present as an ingredient in the RxNorm data
Oxycodone	1.5
Oxymorphone	3
Pentazocine	0.37
Tapentadol	0.4
Tramadol	0.1

*/
define function GetConversionFactor(ingredientCode Code, dailyDose Quantity, doseFormCode Code):
  </a:s>
               <a:s r="332">
                  <a:s r="332">
                     <a:s>case </a:s>
                     <a:s r="118">
                        <a:s>ToInteger(</a:s>
                        <a:s r="117">
                           <a:s r="116">
                              <a:s>ingredientCode</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="117">
                              <a:s>code</a:s>
                           </a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="121">
                        <a:s r="119">when 161 then 0</a:s>
                     </a:s>
                     <a:s>  /*	Acetaminophen */
    </a:s>
                     <a:s r="124">
                        <a:s r="122">when 1191 then 0</a:s>
                     </a:s>
                     <a:s> /*	Aspirin */
    </a:s>
                     <a:s r="127">
                        <a:s r="125">when 1223 then 0</a:s>
                     </a:s>
                     <a:s> /*	Atropine */
    </a:s>
                     <a:s r="130">
                        <a:s r="128">when 1767 then 0</a:s>
                     </a:s>
                     <a:s> /*	Brompheniramine */
    </a:s>
                     <a:s r="141">
                        <a:s r="131">when 1819 then </a:s>
                        <a:s r="140">
                           <a:s>( /*	Buprenorphine */
      </a:s>
                           <a:s r="140">
                              <a:s>case
        </a:s>
                              <a:s r="138">
                                 <a:s>when </a:s>
                                 <a:s r="136">
                                    <a:s r="134">
                                       <a:s>ToInteger(</a:s>
                                       <a:s r="133">
                                          <a:s r="132">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="133">
                                             <a:s>code</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                    <a:s r="135"> = 316987</a:s>
                                 </a:s>
                                 <a:s r="137"> then 12.6</a:s>
                              </a:s>
                              <a:s r="139"> /* Transdermal system */
        else 30 /* Tablet or Film (or Film in MCG) */
      end</a:s>
                           </a:s>
                           <a:s>
    )</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="144">
                        <a:s r="142">when 1841 then 7</a:s>
                     </a:s>
                     <a:s> /*	Butorphanol */
    </a:s>
                     <a:s r="147">
                        <a:s r="145">when 1886 then 0</a:s>
                     </a:s>
                     <a:s> /*	Caffeine */
    </a:s>
                     <a:s r="150">
                        <a:s r="148">when 2101 then 0</a:s>
                     </a:s>
                     <a:s> /*	Carisoprodol */
    </a:s>
                     <a:s r="153">
                        <a:s r="151">when 2354 then 0</a:s>
                     </a:s>
                     <a:s> /*	chlorcyclizine */
    </a:s>
                     <a:s r="156">
                        <a:s r="154">when 2400 then 0</a:s>
                     </a:s>
                     <a:s> /*	Chlorpheniramine */
    </a:s>
                     <a:s r="159">
                        <a:s r="157">when 2670 then 0.15</a:s>
                     </a:s>
                     <a:s> /*	Codeine */
    </a:s>
                     <a:s r="162">
                        <a:s r="160">when 3423 then 4</a:s>
                     </a:s>
                     <a:s> /*	Hydromorphone */
    </a:s>
                     <a:s r="165">
                        <a:s r="163">when 3498 then 0</a:s>
                     </a:s>
                     <a:s> /*	Diphenhydramine */
    </a:s>
                     <a:s r="204">
                        <a:s r="166">when 4337 then </a:s>
                        <a:s r="203">
                           <a:s>( /*	Fentanyl */
      </a:s>
                           <a:s r="203">
                              <a:s>case
        </a:s>
                              <a:s r="176">
                                 <a:s>when </a:s>
                                 <a:s r="174">
                                    <a:s r="169">
                                       <a:s>ToInteger(</a:s>
                                       <a:s r="168">
                                          <a:s r="167">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="168">
                                             <a:s>code</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                    <a:s> in </a:s>
                                    <a:s r="173">
                                       <a:s r="170">{ 970789, 317007, 316992 }</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s r="175"> then 0.13</a:s>
                              </a:s>
                              <a:s> /* Buccal Tablet, Sublingual Tablet, Oral Lozenge */
        </a:s>
                              <a:s r="183">
                                 <a:s>when </a:s>
                                 <a:s r="181">
                                    <a:s r="179">
                                       <a:s>ToInteger(</a:s>
                                       <a:s r="178">
                                          <a:s r="177">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="178">
                                             <a:s>code</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                    <a:s r="180"> = 346163</a:s>
                                 </a:s>
                                 <a:s r="182"> then 0.18</a:s>
                              </a:s>
                              <a:s> /* Buccal Film */
        </a:s>
                              <a:s r="192">
                                 <a:s>when </a:s>
                                 <a:s r="190">
                                    <a:s r="186">
                                       <a:s>ToInteger(</a:s>
                                       <a:s r="185">
                                          <a:s r="184">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="185">
                                             <a:s>code</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                    <a:s> in </a:s>
                                    <a:s r="189">
                                       <a:s r="187">{ 126542, 346163 }</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s r="191"> then 0.16</a:s>
                              </a:s>
                              <a:s> /* Nasal Spray, Mucosal Spray */
        </a:s>
                              <a:s r="196">
                                 <a:s>when </a:s>
                                 <a:s r="194">
                                    <a:s>IsPatch(</a:s>
                                    <a:s r="193">
                                       <a:s>doseFormCode</a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                                 <a:s r="195"> then 2.4</a:s>
                              </a:s>
                              <a:s> /* Transdermal system */
        else </a:s>
                              <a:s r="202">
                                 <a:s r="197">Message(1000, true, </a:s>
                                 <a:s r="199">
                                    <a:s>'Undefined'</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="200">
                                    <a:s>'Error'</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="201">
                                    <a:s>'The dose form is unexpected'</a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s>
      end</a:s>
                           </a:s>
                           <a:s>
    )</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="207">
                        <a:s r="205">when 5032 then 0</a:s>
                     </a:s>
                     <a:s> /*	Guaifenesin */
    </a:s>
                     <a:s r="210">
                        <a:s r="208">when 5489 then 1</a:s>
                     </a:s>
                     <a:s> /*	Hydrocodone */
    </a:s>
                     <a:s r="213">
                        <a:s r="211">when 5640 then 0</a:s>
                     </a:s>
                     <a:s> /*	Ibuprofen */
    </a:s>
                     <a:s r="216">
                        <a:s r="214">when 6102 then 0</a:s>
                     </a:s>
                     <a:s> /*	Kaolin */
    </a:s>
                     <a:s r="219">
                        <a:s r="217">when 6378 then 11</a:s>
                     </a:s>
                     <a:s> /* Levorphanol (NOTE: Given as Levorphanol tartrate in the CDC conversion table) */
    </a:s>
                     <a:s r="222">
                        <a:s r="220">when 6754 then 0.1</a:s>
                     </a:s>
                     <a:s> /*	Meperidine */
    </a:s>
                     <a:s r="261">
                        <a:s r="223">when 6813 then </a:s>
                        <a:s r="260">
                           <a:s>( /*	Methadone */
      </a:s>
                           <a:s r="260">
                              <a:s>case
        </a:s>
                              <a:s r="230">
                                 <a:s>when </a:s>
                                 <a:s r="228">
                                    <a:s r="225">
                                       <a:s r="224">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="225">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s r="226"> between 1 and 20</a:s>
                                 </a:s>
                                 <a:s r="229"> then 4</a:s>
                              </a:s>
                              <a:s>
        </a:s>
                              <a:s r="237">
                                 <a:s>when </a:s>
                                 <a:s r="235">
                                    <a:s r="232">
                                       <a:s r="231">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="232">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s r="233"> between 21 and 40</a:s>
                                 </a:s>
                                 <a:s r="236"> then 8</a:s>
                              </a:s>
                              <a:s>
        </a:s>
                              <a:s r="244">
                                 <a:s>when </a:s>
                                 <a:s r="242">
                                    <a:s r="239">
                                       <a:s r="238">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="239">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s r="240"> between 41 and 60</a:s>
                                 </a:s>
                                 <a:s r="243"> then 10</a:s>
                              </a:s>
                              <a:s>
        </a:s>
                              <a:s r="250">
                                 <a:s>when </a:s>
                                 <a:s r="248">
                                    <a:s r="246">
                                       <a:s r="245">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="246">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s r="247"> >= 61</a:s>
                                 </a:s>
                                 <a:s r="249"> then 12</a:s>
                              </a:s>
                              <a:s>
        else </a:s>
                              <a:s r="259">
                                 <a:s r="251">Message(1000, </a:s>
                                 <a:s r="255">
                                    <a:s r="253">
                                       <a:s r="252">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="253">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s r="254"> &lt; 1</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="256">
                                    <a:s>'Undefined'</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="257">
                                    <a:s>'Error'</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="258">
                                    <a:s>'The dose range is unexpected'</a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s>
      end</a:s>
                           </a:s>
                           <a:s>
    )</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="264">
                        <a:s r="262">when 7052 then 1</a:s>
                     </a:s>
                     <a:s> /*	Morphine */
    </a:s>
                     <a:s r="267">
                        <a:s r="265">when 7242 then 0</a:s>
                     </a:s>
                     <a:s> /*	Naloxone */
    </a:s>
                     <a:s r="270">
                        <a:s r="268">when 7243 then 0</a:s>
                     </a:s>
                     <a:s> /*	Naltrexone */
    </a:s>
                     <a:s r="273">
                        <a:s r="271">when 7804 then 1.5</a:s>
                     </a:s>
                     <a:s> /*	Oxycodone */
    </a:s>
                     <a:s r="276">
                        <a:s r="274">when 7814 then 3</a:s>
                     </a:s>
                     <a:s> /*	Oxymorphone */
    </a:s>
                     <a:s r="279">
                        <a:s r="277">when 8001 then 0.37</a:s>
                     </a:s>
                     <a:s> /*	Pentazocine */
    </a:s>
                     <a:s r="282">
                        <a:s r="280">when 8163 then 0</a:s>
                     </a:s>
                     <a:s> /*	Phenylephrine */
    </a:s>
                     <a:s r="285">
                        <a:s r="283">when 8175 then 0</a:s>
                     </a:s>
                     <a:s> /*	Phenylpropanolamine */
    </a:s>
                     <a:s r="288">
                        <a:s r="286">when 8745 then 0</a:s>
                     </a:s>
                     <a:s> /*	Promethazine */
    </a:s>
                     <a:s r="291">
                        <a:s r="289">when 8896 then 0</a:s>
                     </a:s>
                     <a:s> /*	Pseudoephedrine */
    </a:s>
                     <a:s r="294">
                        <a:s r="292">when 9009 then 0</a:s>
                     </a:s>
                     <a:s> /*	Pyrilamine */
    </a:s>
                     <a:s r="297">
                        <a:s r="295">when 10689 then 0.1</a:s>
                     </a:s>
                     <a:s> /*	Tramadol */
    </a:s>
                     <a:s r="300">
                        <a:s r="298">when 10849 then 0</a:s>
                     </a:s>
                     <a:s> /*	Triprolidine */
    </a:s>
                     <a:s r="303">
                        <a:s r="301">when 19759 then 0</a:s>
                     </a:s>
                     <a:s> /*	bromodiphenhydramine */
    </a:s>
                     <a:s r="306">
                        <a:s r="304">when 19860 then 0</a:s>
                     </a:s>
                     <a:s> /*	butalbital */
    </a:s>
                     <a:s r="309">
                        <a:s r="307">when 22696 then 0</a:s>
                     </a:s>
                     <a:s> /*	dexbrompheniramine */
    </a:s>
                     <a:s r="312">
                        <a:s r="310">when 22697 then 0</a:s>
                     </a:s>
                     <a:s> /*	dexchlorpheniramine */
    </a:s>
                     <a:s r="315">
                        <a:s r="313">when 23088 then 0.25</a:s>
                     </a:s>
                     <a:s> /*	dihydrocodeine */
    </a:s>
                     <a:s r="318">
                        <a:s r="316">when 27084 then 0</a:s>
                     </a:s>
                     <a:s> /*	homatropine */
    </a:s>
                     <a:s r="321">
                        <a:s r="319">when 35780 then 0</a:s>
                     </a:s>
                     <a:s> /*	ropivacaine */
    </a:s>
                     <a:s r="324">
                        <a:s r="322">when 237005 then 8</a:s>
                     </a:s>
                     <a:s> /*	Levomethadyl (NOTE: given as Levomethadyl acetate in the CDC conversion table) */
    </a:s>
                     <a:s r="327">
                        <a:s r="325">when 636827 then 0</a:s>
                     </a:s>
                     <a:s> /*	guaiacolsulfonate */
    </a:s>
                     <a:s r="330">
                        <a:s r="328">when 787390 then 0.4</a:s>
                     </a:s>
                     <a:s r="331"> /*	tapentadol */
    else 0
  end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="332" locator="87:3-154:5" xsi:type="Case">
            <comparand localId="118" locator="87:8-87:37" xsi:type="ToInteger">
               <operand localId="117" locator="87:18-87:36" path="code" xsi:type="Property">
                  <source localId="116" locator="87:18-87:31" name="ingredientCode" xsi:type="OperandRef"/>
               </operand>
            </comparand>
            <caseItem localId="121" locator="88:5-88:19">
               <when localId="119" locator="88:10-88:12" valueType="t:Integer" value="161" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="120" locator="88:19" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="124" locator="89:5-89:20">
               <when localId="122" locator="89:10-89:13" valueType="t:Integer" value="1191" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="123" locator="89:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="127" locator="90:5-90:20">
               <when localId="125" locator="90:10-90:13" valueType="t:Integer" value="1223" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="126" locator="90:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="130" locator="91:5-91:20">
               <when localId="128" locator="91:10-91:13" valueType="t:Integer" value="1767" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="129" locator="91:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="141" locator="92:5-97:5">
               <when localId="131" locator="92:10-92:13" valueType="t:Integer" value="1819" xsi:type="Literal"/>
               <then localId="140" locator="92:20-97:5" xsi:type="Case">
                  <caseItem localId="138" locator="94:9-94:60">
                     <when localId="136" locator="94:14-94:50" xsi:type="Equal">
                        <operand localId="134" locator="94:14-94:41" xsi:type="ToInteger">
                           <operand localId="133" locator="94:24-94:40" path="code" xsi:type="Property">
                              <source localId="132" locator="94:24-94:35" name="doseFormCode" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="135" locator="94:45-94:50" valueType="t:Integer" value="316987" xsi:type="Literal"/>
                     </when>
                     <then localId="137" locator="94:57-94:60" valueType="t:Decimal" value="12.6" xsi:type="Literal"/>
                  </caseItem>
                  <else xsi:type="ToDecimal">
                     <operand localId="139" locator="95:14-95:15" valueType="t:Integer" value="30" xsi:type="Literal"/>
                  </else>
               </then>
            </caseItem>
            <caseItem localId="144" locator="98:5-98:20">
               <when localId="142" locator="98:10-98:13" valueType="t:Integer" value="1841" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="143" locator="98:20" valueType="t:Integer" value="7" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="147" locator="99:5-99:20">
               <when localId="145" locator="99:10-99:13" valueType="t:Integer" value="1886" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="146" locator="99:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="150" locator="100:5-100:20">
               <when localId="148" locator="100:10-100:13" valueType="t:Integer" value="2101" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="149" locator="100:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="153" locator="101:5-101:20">
               <when localId="151" locator="101:10-101:13" valueType="t:Integer" value="2354" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="152" locator="101:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="156" locator="102:5-102:20">
               <when localId="154" locator="102:10-102:13" valueType="t:Integer" value="2400" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="155" locator="102:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="159" locator="103:5-103:23">
               <when localId="157" locator="103:10-103:13" valueType="t:Integer" value="2670" xsi:type="Literal"/>
               <then localId="158" locator="103:20-103:23" valueType="t:Decimal" value="0.15" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="162" locator="104:5-104:20">
               <when localId="160" locator="104:10-104:13" valueType="t:Integer" value="3423" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="161" locator="104:20" valueType="t:Integer" value="4" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="165" locator="105:5-105:20">
               <when localId="163" locator="105:10-105:13" valueType="t:Integer" value="3498" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="164" locator="105:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="204" locator="106:5-114:5">
               <when localId="166" locator="106:10-106:13" valueType="t:Integer" value="4337" xsi:type="Literal"/>
               <then localId="203" locator="106:20-114:5" xsi:type="Case">
                  <caseItem localId="176" locator="108:9-108:81">
                     <when localId="174" locator="108:14-108:71" xsi:type="In">
                        <operand localId="169" locator="108:14-108:41" xsi:type="ToInteger">
                           <operand localId="168" locator="108:24-108:40" path="code" xsi:type="Property">
                              <source localId="167" locator="108:24-108:35" name="doseFormCode" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="173" locator="108:46-108:71" xsi:type="List">
                           <element localId="170" locator="108:48-108:53" valueType="t:Integer" value="970789" xsi:type="Literal"/>
                           <element localId="171" locator="108:56-108:61" valueType="t:Integer" value="317007" xsi:type="Literal"/>
                           <element localId="172" locator="108:64-108:69" valueType="t:Integer" value="316992" xsi:type="Literal"/>
                        </operand>
                     </when>
                     <then localId="175" locator="108:78-108:81" valueType="t:Decimal" value="0.13" xsi:type="Literal"/>
                  </caseItem>
                  <caseItem localId="183" locator="109:9-109:60">
                     <when localId="181" locator="109:14-109:50" xsi:type="Equal">
                        <operand localId="179" locator="109:14-109:41" xsi:type="ToInteger">
                           <operand localId="178" locator="109:24-109:40" path="code" xsi:type="Property">
                              <source localId="177" locator="109:24-109:35" name="doseFormCode" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="180" locator="109:45-109:50" valueType="t:Integer" value="346163" xsi:type="Literal"/>
                     </when>
                     <then localId="182" locator="109:57-109:60" valueType="t:Decimal" value="0.18" xsi:type="Literal"/>
                  </caseItem>
                  <caseItem localId="192" locator="110:9-110:73">
                     <when localId="190" locator="110:14-110:63" xsi:type="In">
                        <operand localId="186" locator="110:14-110:41" xsi:type="ToInteger">
                           <operand localId="185" locator="110:24-110:40" path="code" xsi:type="Property">
                              <source localId="184" locator="110:24-110:35" name="doseFormCode" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="189" locator="110:46-110:63" xsi:type="List">
                           <element localId="187" locator="110:48-110:53" valueType="t:Integer" value="126542" xsi:type="Literal"/>
                           <element localId="188" locator="110:56-110:61" valueType="t:Integer" value="346163" xsi:type="Literal"/>
                        </operand>
                     </when>
                     <then localId="191" locator="110:70-110:73" valueType="t:Decimal" value="0.16" xsi:type="Literal"/>
                  </caseItem>
                  <caseItem localId="196" locator="111:9-111:43">
                     <when localId="194" locator="111:14-111:34" name="IsPatch" xsi:type="FunctionRef">
                        <operand localId="193" locator="111:22-111:33" name="doseFormCode" xsi:type="OperandRef"/>
                     </when>
                     <then localId="195" locator="111:41-111:43" valueType="t:Decimal" value="2.4" xsi:type="Literal"/>
                  </caseItem>
                  <else xsi:type="ToDecimal">
                     <operand localId="202" locator="112:14-112:85" xsi:type="Message">
                        <source localId="197" locator="112:22-112:25" valueType="t:Integer" value="1000" xsi:type="Literal"/>
                        <condition localId="198" locator="112:28-112:31" valueType="t:Boolean" value="true" xsi:type="Literal"/>
                        <code localId="199" locator="112:34-112:44" valueType="t:String" value="Undefined" xsi:type="Literal"/>
                        <severity localId="200" locator="112:47-112:53" valueType="t:String" value="Error" xsi:type="Literal"/>
                        <message localId="201" locator="112:56-112:84" valueType="t:String" value="The dose form is unexpected" xsi:type="Literal"/>
                     </operand>
                  </else>
               </then>
            </caseItem>
            <caseItem localId="207" locator="115:5-115:20">
               <when localId="205" locator="115:10-115:13" valueType="t:Integer" value="5032" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="206" locator="115:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="210" locator="116:5-116:20">
               <when localId="208" locator="116:10-116:13" valueType="t:Integer" value="5489" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="209" locator="116:20" valueType="t:Integer" value="1" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="213" locator="117:5-117:20">
               <when localId="211" locator="117:10-117:13" valueType="t:Integer" value="5640" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="212" locator="117:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="216" locator="118:5-118:20">
               <when localId="214" locator="118:10-118:13" valueType="t:Integer" value="6102" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="215" locator="118:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="219" locator="119:5-119:21">
               <when localId="217" locator="119:10-119:13" valueType="t:Integer" value="6378" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="218" locator="119:20-119:21" valueType="t:Integer" value="11" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="222" locator="120:5-120:22">
               <when localId="220" locator="120:10-120:13" valueType="t:Integer" value="6754" xsi:type="Literal"/>
               <then localId="221" locator="120:20-120:22" valueType="t:Decimal" value="0.1" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="261" locator="121:5-129:5">
               <when localId="223" locator="121:10-121:13" valueType="t:Integer" value="6813" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="260" locator="121:20-129:5" xsi:type="Case">
                     <caseItem localId="230" locator="123:9-123:52">
                        <when localId="228" locator="123:14-123:45" xsi:type="And">
                           <operand xsi:type="GreaterOrEqual">
                              <operand localId="225" locator="123:14-123:28" path="value" xsi:type="Property">
                                 <source localId="224" locator="123:14-123:22" name="dailyDose" xsi:type="OperandRef"/>
                              </operand>
                              <operand xsi:type="ToDecimal">
                                 <operand localId="226" locator="123:38" valueType="t:Integer" value="1" xsi:type="Literal"/>
                              </operand>
                           </operand>
                           <operand xsi:type="LessOrEqual">
                              <operand localId="225" locator="123:14-123:28" path="value" xsi:type="Property">
                                 <source localId="224" locator="123:14-123:22" name="dailyDose" xsi:type="OperandRef"/>
                              </operand>
                              <operand xsi:type="ToDecimal">
                                 <operand localId="227" locator="123:44-123:45" valueType="t:Integer" value="20" xsi:type="Literal"/>
                              </operand>
                           </operand>
                        </when>
                        <then localId="229" locator="123:52" valueType="t:Integer" value="4" xsi:type="Literal"/>
                     </caseItem>
                     <caseItem localId="237" locator="124:9-124:53">
                        <when localId="235" locator="124:14-124:46" xsi:type="And">
                           <operand xsi:type="GreaterOrEqual">
                              <operand localId="232" locator="124:14-124:28" path="value" xsi:type="Property">
                                 <source localId="231" locator="124:14-124:22" name="dailyDose" xsi:type="OperandRef"/>
                              </operand>
                              <operand xsi:type="ToDecimal">
                                 <operand localId="233" locator="124:38-124:39" valueType="t:Integer" value="21" xsi:type="Literal"/>
                              </operand>
                           </operand>
                           <operand xsi:type="LessOrEqual">
                              <operand localId="232" locator="124:14-124:28" path="value" xsi:type="Property">
                                 <source localId="231" locator="124:14-124:22" name="dailyDose" xsi:type="OperandRef"/>
                              </operand>
                              <operand xsi:type="ToDecimal">
                                 <operand localId="234" locator="124:45-124:46" valueType="t:Integer" value="40" xsi:type="Literal"/>
                              </operand>
                           </operand>
                        </when>
                        <then localId="236" locator="124:53" valueType="t:Integer" value="8" xsi:type="Literal"/>
                     </caseItem>
                     <caseItem localId="244" locator="125:9-125:54">
                        <when localId="242" locator="125:14-125:46" xsi:type="And">
                           <operand xsi:type="GreaterOrEqual">
                              <operand localId="239" locator="125:14-125:28" path="value" xsi:type="Property">
                                 <source localId="238" locator="125:14-125:22" name="dailyDose" xsi:type="OperandRef"/>
                              </operand>
                              <operand xsi:type="ToDecimal">
                                 <operand localId="240" locator="125:38-125:39" valueType="t:Integer" value="41" xsi:type="Literal"/>
                              </operand>
                           </operand>
                           <operand xsi:type="LessOrEqual">
                              <operand localId="239" locator="125:14-125:28" path="value" xsi:type="Property">
                                 <source localId="238" locator="125:14-125:22" name="dailyDose" xsi:type="OperandRef"/>
                              </operand>
                              <operand xsi:type="ToDecimal">
                                 <operand localId="241" locator="125:45-125:46" valueType="t:Integer" value="60" xsi:type="Literal"/>
                              </operand>
                           </operand>
                        </when>
                        <then localId="243" locator="125:53-125:54" valueType="t:Integer" value="10" xsi:type="Literal"/>
                     </caseItem>
                     <caseItem localId="250" locator="126:9-126:42">
                        <when localId="248" locator="126:14-126:34" xsi:type="GreaterOrEqual">
                           <operand localId="246" locator="126:14-126:28" path="value" xsi:type="Property">
                              <source localId="245" locator="126:14-126:22" name="dailyDose" xsi:type="OperandRef"/>
                           </operand>
                           <operand xsi:type="ToDecimal">
                              <operand localId="247" locator="126:33-126:34" valueType="t:Integer" value="61" xsi:type="Literal"/>
                           </operand>
                        </when>
                        <then localId="249" locator="126:41-126:42" valueType="t:Integer" value="12" xsi:type="Literal"/>
                     </caseItem>
                     <else localId="259" locator="127:14-127:101" xsi:type="Message">
                        <source localId="251" locator="127:22-127:25" valueType="t:Integer" value="1000" xsi:type="Literal"/>
                        <condition localId="255" locator="127:28-127:46" xsi:type="Less">
                           <operand localId="253" locator="127:28-127:42" path="value" xsi:type="Property">
                              <source localId="252" locator="127:28-127:36" name="dailyDose" xsi:type="OperandRef"/>
                           </operand>
                           <operand xsi:type="ToDecimal">
                              <operand localId="254" locator="127:46" valueType="t:Integer" value="1" xsi:type="Literal"/>
                           </operand>
                        </condition>
                        <code localId="256" locator="127:49-127:59" valueType="t:String" value="Undefined" xsi:type="Literal"/>
                        <severity localId="257" locator="127:62-127:68" valueType="t:String" value="Error" xsi:type="Literal"/>
                        <message localId="258" locator="127:71-127:100" valueType="t:String" value="The dose range is unexpected" xsi:type="Literal"/>
                     </else>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="264" locator="130:5-130:20">
               <when localId="262" locator="130:10-130:13" valueType="t:Integer" value="7052" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="263" locator="130:20" valueType="t:Integer" value="1" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="267" locator="131:5-131:20">
               <when localId="265" locator="131:10-131:13" valueType="t:Integer" value="7242" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="266" locator="131:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="270" locator="132:5-132:20">
               <when localId="268" locator="132:10-132:13" valueType="t:Integer" value="7243" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="269" locator="132:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="273" locator="133:5-133:22">
               <when localId="271" locator="133:10-133:13" valueType="t:Integer" value="7804" xsi:type="Literal"/>
               <then localId="272" locator="133:20-133:22" valueType="t:Decimal" value="1.5" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="276" locator="134:5-134:20">
               <when localId="274" locator="134:10-134:13" valueType="t:Integer" value="7814" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="275" locator="134:20" valueType="t:Integer" value="3" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="279" locator="135:5-135:23">
               <when localId="277" locator="135:10-135:13" valueType="t:Integer" value="8001" xsi:type="Literal"/>
               <then localId="278" locator="135:20-135:23" valueType="t:Decimal" value="0.37" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="282" locator="136:5-136:20">
               <when localId="280" locator="136:10-136:13" valueType="t:Integer" value="8163" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="281" locator="136:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="285" locator="137:5-137:20">
               <when localId="283" locator="137:10-137:13" valueType="t:Integer" value="8175" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="284" locator="137:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="288" locator="138:5-138:20">
               <when localId="286" locator="138:10-138:13" valueType="t:Integer" value="8745" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="287" locator="138:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="291" locator="139:5-139:20">
               <when localId="289" locator="139:10-139:13" valueType="t:Integer" value="8896" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="290" locator="139:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="294" locator="140:5-140:20">
               <when localId="292" locator="140:10-140:13" valueType="t:Integer" value="9009" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="293" locator="140:20" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="297" locator="141:5-141:23">
               <when localId="295" locator="141:10-141:14" valueType="t:Integer" value="10689" xsi:type="Literal"/>
               <then localId="296" locator="141:21-141:23" valueType="t:Decimal" value="0.1" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="300" locator="142:5-142:21">
               <when localId="298" locator="142:10-142:14" valueType="t:Integer" value="10849" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="299" locator="142:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="303" locator="143:5-143:21">
               <when localId="301" locator="143:10-143:14" valueType="t:Integer" value="19759" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="302" locator="143:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="306" locator="144:5-144:21">
               <when localId="304" locator="144:10-144:14" valueType="t:Integer" value="19860" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="305" locator="144:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="309" locator="145:5-145:21">
               <when localId="307" locator="145:10-145:14" valueType="t:Integer" value="22696" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="308" locator="145:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="312" locator="146:5-146:21">
               <when localId="310" locator="146:10-146:14" valueType="t:Integer" value="22697" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="311" locator="146:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="315" locator="147:5-147:24">
               <when localId="313" locator="147:10-147:14" valueType="t:Integer" value="23088" xsi:type="Literal"/>
               <then localId="314" locator="147:21-147:24" valueType="t:Decimal" value="0.25" xsi:type="Literal"/>
            </caseItem>
            <caseItem localId="318" locator="148:5-148:21">
               <when localId="316" locator="148:10-148:14" valueType="t:Integer" value="27084" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="317" locator="148:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="321" locator="149:5-149:21">
               <when localId="319" locator="149:10-149:14" valueType="t:Integer" value="35780" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="320" locator="149:21" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="324" locator="150:5-150:22">
               <when localId="322" locator="150:10-150:15" valueType="t:Integer" value="237005" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="323" locator="150:22" valueType="t:Integer" value="8" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="327" locator="151:5-151:22">
               <when localId="325" locator="151:10-151:15" valueType="t:Integer" value="636827" xsi:type="Literal"/>
               <then xsi:type="ToDecimal">
                  <operand localId="326" locator="151:22" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </then>
            </caseItem>
            <caseItem localId="330" locator="152:5-152:24">
               <when localId="328" locator="152:10-152:15" valueType="t:Integer" value="787390" xsi:type="Literal"/>
               <then localId="329" locator="152:22-152:24" valueType="t:Decimal" value="0.4" xsi:type="Literal"/>
            </caseItem>
            <else xsi:type="ToDecimal">
               <operand localId="331" locator="153:10" valueType="t:Integer" value="0" xsi:type="Literal"/>
            </else>
         </expression>
         <operand name="ingredientCode">
            <operandTypeSpecifier localId="113" locator="86:52-86:55" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="dailyDose">
            <operandTypeSpecifier localId="114" locator="86:68-86:75" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="doseFormCode">
            <operandTypeSpecifier localId="115" locator="86:91-86:94" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="359" locator="156:1-163:12" name="EnsureMicrogramQuantity" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="359">
               <a:s>define function EnsureMicrogramQuantity(strength Quantity):
  </a:s>
               <a:s r="358">
                  <a:s r="358">
                     <a:s>if </a:s>
                     <a:s r="345">
                        <a:s r="338">
                           <a:s r="336">
                              <a:s r="335">
                                 <a:s>strength</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="336">
                                 <a:s>value</a:s>
                              </a:s>
                           </a:s>
                           <a:s r="337"> &lt; 0.1</a:s>
                        </a:s>
                        <a:s> and </a:s>
                        <a:s r="344">
                           <a:s>(</a:s>
                           <a:s r="344">
                              <a:s r="342">
                                 <a:s>PositionOf(</a:s>
                                 <a:s r="339">
                                    <a:s>'mg'</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="341">
                                    <a:s r="340">
                                       <a:s>strength</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="341">
                                       <a:s>unit</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s r="343"> = 0</a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                     </a:s>
                     <a:s> then
    </a:s>
                     <a:s r="356">
                        <a:s>Quantity {
      </a:s>
                        <a:s>
                           <a:s>value: </a:s>
                           <a:s r="349">
                              <a:s r="347">
                                 <a:s r="346">
                                    <a:s>strength</a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="347">
                                    <a:s>value</a:s>
                                 </a:s>
                              </a:s>
                              <a:s r="348"> * 1000</a:s>
                           </a:s>
                        </a:s>
                        <a:s>,
      </a:s>
                        <a:s>
                           <a:s>unit: </a:s>
                           <a:s r="355">
                              <a:s r="350">
                                 <a:s>'mcg'</a:s>
                              </a:s>
                              <a:s> + </a:s>
                              <a:s r="354">
                                 <a:s>Substring(</a:s>
                                 <a:s r="352">
                                    <a:s r="351">
                                       <a:s>strength</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="352">
                                       <a:s>unit</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s r="353">, 2)</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>
    }</a:s>
                     </a:s>
                     <a:s>
  else
    </a:s>
                     <a:s r="357">
                        <a:s>strength</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="358" locator="157:3-163:12" xsi:type="If">
            <condition localId="345" locator="157:6-157:67" xsi:type="And">
               <operand localId="338" locator="157:6-157:25" xsi:type="Less">
                  <operand localId="336" locator="157:6-157:19" path="value" xsi:type="Property">
                     <source localId="335" locator="157:6-157:13" name="strength" xsi:type="OperandRef"/>
                  </operand>
                  <operand localId="337" locator="157:23-157:25" valueType="t:Decimal" value="0.1" xsi:type="Literal"/>
               </operand>
               <operand localId="344" locator="157:31-157:67" xsi:type="Equal">
                  <operand localId="342" locator="157:32-157:62" xsi:type="PositionOf">
                     <pattern localId="339" locator="157:43-157:46" valueType="t:String" value="mg" xsi:type="Literal"/>
                     <string localId="341" locator="157:49-157:61" path="unit" xsi:type="Property">
                        <source localId="340" locator="157:49-157:56" name="strength" xsi:type="OperandRef"/>
                     </string>
                  </operand>
                  <operand localId="343" locator="157:66" valueType="t:Integer" value="0" xsi:type="Literal"/>
               </operand>
            </condition>
            <then localId="356" locator="158:5-161:5" classType="t:Quantity" xsi:type="Instance">
               <element name="value">
                  <value localId="349" locator="159:14-159:34" xsi:type="Multiply">
                     <operand localId="347" locator="159:14-159:27" path="value" xsi:type="Property">
                        <source localId="346" locator="159:14-159:21" name="strength" xsi:type="OperandRef"/>
                     </operand>
                     <operand xsi:type="ToDecimal">
                        <operand localId="348" locator="159:31-159:34" valueType="t:Integer" value="1000" xsi:type="Literal"/>
                     </operand>
                  </value>
               </element>
               <element name="unit">
                  <value localId="355" locator="160:13-160:47" xsi:type="Concatenate">
                     <operand localId="350" locator="160:13-160:17" valueType="t:String" value="mcg" xsi:type="Literal"/>
                     <operand localId="354" locator="160:21-160:47" xsi:type="Substring">
                        <stringToSub localId="352" locator="160:31-160:43" path="unit" xsi:type="Property">
                           <source localId="351" locator="160:31-160:38" name="strength" xsi:type="OperandRef"/>
                        </stringToSub>
                        <startIndex localId="353" locator="160:46" valueType="t:Integer" value="2" xsi:type="Literal"/>
                     </operand>
                  </value>
               </element>
            </then>
            <else localId="357" locator="163:5-163:12" name="strength" xsi:type="OperandRef"/>
         </expression>
         <operand name="strength">
            <operandTypeSpecifier localId="334" locator="156:50-156:57" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="379" locator="178:1-188:3" name="GetIngredients" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="379">
               <a:s>/*
  Returns the non-surgical opioid ingredients and their strengths that
  make up the drug identified by the given rxNormCode as a list of tuples:

  List&lt;Tuple {
    rxNormCode Code,
    doseFormCode Code,
    doseFormName String,
    ingredientCode Code,
    ingredientName String,
    strength Quantity
  }>
*/
define function GetIngredients(rxNormCode Code):
  </a:s>
               <a:s r="378">
                  <a:s r="378">
                     <a:s>{
    </a:s>
                     <a:s r="377">
                        <a:s>{
      </a:s>
                        <a:s>
                           <a:s>rxNormCode: </a:s>
                           <a:s r="361">
                              <a:s>rxNormCode</a:s>
                           </a:s>
                        </a:s>
                        <a:s>,
      </a:s>
                        <a:s>
                           <a:s>doseFormCode: </a:s>
                           <a:s r="364">
                              <a:s r="362">null as </a:s>
                              <a:s r="363">
                                 <a:s>Code</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>,
      </a:s>
                        <a:s>
                           <a:s>doseFormName: </a:s>
                           <a:s r="367">
                              <a:s r="365">null as </a:s>
                              <a:s r="366">
                                 <a:s>String</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>,
      </a:s>
                        <a:s>
                           <a:s>ingredientCode: </a:s>
                           <a:s r="370">
                              <a:s r="368">null as </a:s>
                              <a:s r="369">
                                 <a:s>Code</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>,
      </a:s>
                        <a:s>
                           <a:s>ingredientName: </a:s>
                           <a:s r="373">
                              <a:s r="371">null as </a:s>
                              <a:s r="372">
                                 <a:s>String</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>,
      </a:s>
                        <a:s>
                           <a:s>strength: </a:s>
                           <a:s r="376">
                              <a:s r="374">null as </a:s>
                              <a:s r="375">
                                 <a:s>Quantity</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>
    }</a:s>
                     </a:s>
                     <a:s>
  }</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="378" locator="179:3-188:3" xsi:type="List">
            <element localId="377" locator="180:5-187:5" xsi:type="Tuple">
               <element name="rxNormCode">
                  <value localId="361" locator="181:19-181:28" name="rxNormCode" xsi:type="OperandRef"/>
               </element>
               <element name="doseFormCode">
                  <value localId="364" locator="182:21-182:32" strict="false" xsi:type="As">
                     <operand localId="362" locator="182:21-182:24" xsi:type="Null"/>
                     <asTypeSpecifier localId="363" locator="182:29-182:32" name="t:Code" xsi:type="NamedTypeSpecifier"/>
                  </value>
               </element>
               <element name="doseFormName">
                  <value localId="367" locator="183:21-183:34" strict="false" xsi:type="As">
                     <operand localId="365" locator="183:21-183:24" xsi:type="Null"/>
                     <asTypeSpecifier localId="366" locator="183:29-183:34" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  </value>
               </element>
               <element name="ingredientCode">
                  <value localId="370" locator="184:23-184:34" strict="false" xsi:type="As">
                     <operand localId="368" locator="184:23-184:26" xsi:type="Null"/>
                     <asTypeSpecifier localId="369" locator="184:31-184:34" name="t:Code" xsi:type="NamedTypeSpecifier"/>
                  </value>
               </element>
               <element name="ingredientName">
                  <value localId="373" locator="185:23-185:36" strict="false" xsi:type="As">
                     <operand localId="371" locator="185:23-185:26" xsi:type="Null"/>
                     <asTypeSpecifier localId="372" locator="185:31-185:36" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  </value>
               </element>
               <element name="strength">
                  <value localId="376" locator="186:17-186:32" strict="false" xsi:type="As">
                     <operand localId="374" locator="186:17-186:20" xsi:type="Null"/>
                     <asTypeSpecifier localId="375" locator="186:25-186:32" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                  </value>
               </element>
            </element>
         </expression>
         <operand name="rxNormCode">
            <operandTypeSpecifier localId="360" locator="178:43-178:46" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="468" locator="226:1-247:5" name="GetDailyDose" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="468">
               <a:s>/*
  (
    [MED_SCDC_FOR_DRUG: DRUG_RXCUI in rxNormCode] SD
      where exists ([NON_SURGICAL_OPIOID_TO_INCLUDE: DRUG_RXCUI in SD.DRUG_RXCUI])
      return {
        rxNormCode: rxNormCode,
        component: SingletonFrom([MED_SCDC: SCDC_RXCUI in SD.SCDC_RXCUI]),
        ingredientCode: SingletonFrom([MED_INGREDIENT_FOR_SCDC: SCDC_RXCUI in SD.SCDC_RXCUI]).INGREDIENT_RXCUI,
        doseFormCode: SingletonFrom([MED_DRUG_DOSE_FORM: DRUG_RXCUI in SD.DRUG_RXCUI]).DOSE_FORM_RXCUI // Could potentially look this up only once...
      }
  ) C
    let
      ingredient: SingletonFrom([MED_INGREDIENT: INGREDIENT_RXCUI in C.ingredientCode]),
      doseForm: SingletonFrom([MED_DOSE_FORM: DOSE_FORM_RXCUI in C.doseFormCode])
    where exists (
      [MED_INGREDIENT_TYPE: INGREDIENT_RXCUI in C.ingredientCode] IT
        where IT.INGREDIENT_TYPE = 'NonSurgicalOpioid'
    )
    return {
      rxNormCode: rxNormCode,
      doseFormCode: C.doseFormCode,
      doseFormName: doseForm.DOSE_FORM_NAME,
      ingredientCode: C.ingredientCode,
      ingredientName: ingredient.INGREDIENT_NAME,
      strength:
        EnsureMicrogramQuantity(
          Quantity {
            value: C.component.STRENGTH_VALUE,
            unit: ToUCUM(C.component.STRENGTH_UNIT)
          }
        )
    }
*/

/*
  Calculates daily dose for a specific ingredient based on the ingredient strength, dose form, dose quantity, and daily frequency
*/
define function GetDailyDose(ingredientCode Code, strength Quantity, doseFormCode Code, doseQuantity Quantity, dosesPerDay Decimal):
  </a:s>
               <a:s r="467">
                  <a:s r="467">
                     <a:s>case
	  /* if patch --> daily dose = dose value (e.g, number patches with doseQuantity unit = &quot;patch&quot;) * per-hour strength */
    </a:s>
                     <a:s r="404">
                        <a:s>when </a:s>
                        <a:s r="386">
                           <a:s>IsPatch(</a:s>
                           <a:s r="385">
                              <a:s>doseFormCode</a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                        <a:s> then
      /* buprenorphine or fentanyl patch */
      </a:s>
                        <a:s r="403">
                           <a:s>if </a:s>
                           <a:s r="393">
                              <a:s r="389">
                                 <a:s>ToInteger(</a:s>
                                 <a:s r="388">
                                    <a:s r="387">
                                       <a:s>ingredientCode</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="388">
                                       <a:s>code</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s> in </a:s>
                              <a:s r="392">
                                 <a:s r="390">{ 1819, 4337 }</a:s>
                              </a:s>
                           </a:s>
                           <a:s> then
        </a:s>
                           <a:s r="401">
                              <a:s>Quantity { </a:s>
                              <a:s>
                                 <a:s>value: </a:s>
                                 <a:s r="398">
                                    <a:s r="395">
                                       <a:s r="394">
                                          <a:s>doseQuantity</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="395">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> * </a:s>
                                    <a:s r="397">
                                       <a:s r="396">
                                          <a:s>strength</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="397">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>, </a:s>
                              <a:s>
                                 <a:s>unit: </a:s>
                                 <a:s r="400">
                                    <a:s r="399">
                                       <a:s>strength</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="400">
                                       <a:s>unit</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s> }</a:s>
                           </a:s>
                           <a:s r="402">
      else
        null</a:s>
                        </a:s>
                     </a:s>
                     <a:s>

    /* if dose unit in actual mass units (mg or mcg -- when it's a single med) --> daily dose = numTimesPerDay * dose */
    </a:s>
                     <a:s r="418">
                        <a:s>when </a:s>
                        <a:s r="410">
                           <a:s r="406">
                              <a:s r="405">
                                 <a:s>doseQuantity</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="406">
                                 <a:s>unit</a:s>
                              </a:s>
                           </a:s>
                           <a:s> in </a:s>
                           <a:s r="409">
                              <a:s>{ </a:s>
                              <a:s r="407">
                                 <a:s>'mg'</a:s>
                              </a:s>
                              <a:s>, </a:s>
                              <a:s r="408">
                                 <a:s>'mcg'</a:s>
                              </a:s>
                              <a:s> }</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
      </a:s>
                        <a:s r="417">
                           <a:s>Quantity { </a:s>
                           <a:s>
                              <a:s>value: </a:s>
                              <a:s r="414">
                                 <a:s r="411">
                                    <a:s>dosesPerDay</a:s>
                                 </a:s>
                                 <a:s> * </a:s>
                                 <a:s r="413">
                                    <a:s r="412">
                                       <a:s>doseQuantity</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="413">
                                       <a:s>value</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                           <a:s>, </a:s>
                           <a:s>
                              <a:s>unit: </a:s>
                              <a:s r="416">
                                 <a:s r="415">
                                    <a:s>doseQuantity</a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="416">
                                    <a:s>unit</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                           <a:s> }</a:s>
                        </a:s>
                     </a:s>
                     <a:s>

    /* if doseQuantity is in actual volume units (mL) --> daily dose = numTimesPerDay * dose * strength */
    </a:s>
                     <a:s r="450">
                        <a:s>when </a:s>
                        <a:s r="433">
                           <a:s r="422">
                              <a:s r="420">
                                 <a:s r="419">
                                    <a:s>doseQuantity</a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="420">
                                    <a:s>unit</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> = </a:s>
                              <a:s r="421">
                                 <a:s>'mL'</a:s>
                              </a:s>
                           </a:s>
                           <a:s> and </a:s>
                           <a:s r="432">
                              <a:s>(</a:s>
                              <a:s r="432">
                                 <a:s r="426">
                                    <a:s>PositionOf(</a:s>
                                    <a:s r="423">
                                       <a:s>'/mL'</a:s>
                                    </a:s>
                                    <a:s>, </a:s>
                                    <a:s r="425">
                                       <a:s r="424">
                                          <a:s>strength</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="425">
                                          <a:s>unit</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                                 <a:s> = </a:s>
                                 <a:s r="431">
                                    <a:s r="429">
                                       <a:s>Length(</a:s>
                                       <a:s r="428">
                                          <a:s r="427">
                                             <a:s>strength</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="428">
                                             <a:s>unit</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                    <a:s r="430"> - 3</a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
      </a:s>
                        <a:s r="449">
                           <a:s>Quantity { </a:s>
                           <a:s>
                              <a:s>value: </a:s>
                              <a:s r="440">
                                 <a:s r="437">
                                    <a:s r="434">
                                       <a:s>dosesPerDay</a:s>
                                    </a:s>
                                    <a:s> * </a:s>
                                    <a:s r="436">
                                       <a:s r="435">
                                          <a:s>doseQuantity</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="436">
                                          <a:s>value</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> * </a:s>
                                 <a:s r="439">
                                    <a:s r="438">
                                       <a:s>strength</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="439">
                                       <a:s>value</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                           <a:s>, </a:s>
                           <a:s>
                              <a:s>unit: </a:s>
                              <a:s r="448">
                                 <a:s>Substring(</a:s>
                                 <a:s r="442">
                                    <a:s r="441">
                                       <a:s>strength</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="442">
                                       <a:s>unit</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s r="443">, 0, </a:s>
                                 <a:s r="447">
                                    <a:s>PositionOf(</a:s>
                                    <a:s r="444">
                                       <a:s>'/'</a:s>
                                    </a:s>
                                    <a:s>, </a:s>
                                    <a:s r="446">
                                       <a:s r="445">
                                          <a:s>strength</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="446">
                                          <a:s>unit</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s> }</a:s>
                        </a:s>
                     </a:s>
                     <a:s>

		/* if doseQuantity is not in actual units (e.g., 1 tab, 1 spray -- when it's a combo med with a unit of tablet, or it's mg/actuat) -->  daily dose = numTimesPerDay * dose value * strength value */
    else
      </a:s>
                     <a:s r="466">
                        <a:s>Quantity { </a:s>
                        <a:s>
                           <a:s>value: </a:s>
                           <a:s r="457">
                              <a:s r="454">
                                 <a:s r="451">
                                    <a:s>dosesPerDay</a:s>
                                 </a:s>
                                 <a:s> * </a:s>
                                 <a:s r="453">
                                    <a:s r="452">
                                       <a:s>doseQuantity</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="453">
                                       <a:s>value</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s> * </a:s>
                              <a:s r="456">
                                 <a:s r="455">
                                    <a:s>strength</a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="456">
                                    <a:s>value</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s>
                           <a:s>unit: </a:s>
                           <a:s r="465">
                              <a:s>Substring(</a:s>
                              <a:s r="459">
                                 <a:s r="458">
                                    <a:s>strength</a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="459">
                                    <a:s>unit</a:s>
                                 </a:s>
                              </a:s>
                              <a:s r="460">, 0, </a:s>
                              <a:s r="464">
                                 <a:s>PositionOf(</a:s>
                                 <a:s r="461">
                                    <a:s>'/'</a:s>
                                 </a:s>
                                 <a:s>, </a:s>
                                 <a:s r="463">
                                    <a:s r="462">
                                       <a:s>strength</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="463">
                                       <a:s>unit</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                        <a:s> }</a:s>
                     </a:s>
                     <a:s>
  end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="467" locator="227:3-247:5" xsi:type="Case">
            <caseItem localId="404" locator="229:5-234:12">
               <when localId="386" locator="229:10-229:30" name="IsPatch" xsi:type="FunctionRef">
                  <operand localId="385" locator="229:18-229:29" name="doseFormCode" xsi:type="OperandRef"/>
               </when>
               <then localId="403" locator="231:7-234:12" xsi:type="If">
                  <condition localId="393" locator="231:10-231:57" xsi:type="In">
                     <operand localId="389" locator="231:10-231:39" xsi:type="ToInteger">
                        <operand localId="388" locator="231:20-231:38" path="code" xsi:type="Property">
                           <source localId="387" locator="231:20-231:33" name="ingredientCode" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                     <operand localId="392" locator="231:44-231:57" xsi:type="List">
                        <element localId="390" locator="231:46-231:49" valueType="t:Integer" value="1819" xsi:type="Literal"/>
                        <element localId="391" locator="231:52-231:55" valueType="t:Integer" value="4337" xsi:type="Literal"/>
                     </operand>
                  </condition>
                  <then localId="401" locator="232:9-232:84" classType="t:Quantity" xsi:type="Instance">
                     <element name="value">
                        <value localId="398" locator="232:27-232:61" xsi:type="Multiply">
                           <operand localId="395" locator="232:27-232:44" path="value" xsi:type="Property">
                              <source localId="394" locator="232:27-232:38" name="doseQuantity" xsi:type="OperandRef"/>
                           </operand>
                           <operand localId="397" locator="232:48-232:61" path="value" xsi:type="Property">
                              <source localId="396" locator="232:48-232:55" name="strength" xsi:type="OperandRef"/>
                           </operand>
                        </value>
                     </element>
                     <element name="unit">
                        <value localId="400" locator="232:70-232:82" path="unit" xsi:type="Property">
                           <source localId="399" locator="232:70-232:77" name="strength" xsi:type="OperandRef"/>
                        </value>
                     </element>
                  </then>
                  <else asType="t:Quantity" xsi:type="As">
                     <operand localId="402" locator="234:9-234:12" xsi:type="Null"/>
                  </else>
               </then>
            </caseItem>
            <caseItem localId="418" locator="237:5-238:83">
               <when localId="410" locator="237:10-237:45" xsi:type="In">
                  <operand localId="406" locator="237:10-237:26" path="unit" xsi:type="Property">
                     <source localId="405" locator="237:10-237:21" name="doseQuantity" xsi:type="OperandRef"/>
                  </operand>
                  <operand localId="409" locator="237:31-237:45" xsi:type="List">
                     <element localId="407" locator="237:33-237:36" valueType="t:String" value="mg" xsi:type="Literal"/>
                     <element localId="408" locator="237:39-237:43" valueType="t:String" value="mcg" xsi:type="Literal"/>
                  </operand>
               </when>
               <then localId="417" locator="238:7-238:83" classType="t:Quantity" xsi:type="Instance">
                  <element name="value">
                     <value localId="414" locator="238:25-238:56" xsi:type="Multiply">
                        <operand localId="411" locator="238:25-238:35" name="dosesPerDay" xsi:type="OperandRef"/>
                        <operand localId="413" locator="238:39-238:56" path="value" xsi:type="Property">
                           <source localId="412" locator="238:39-238:50" name="doseQuantity" xsi:type="OperandRef"/>
                        </operand>
                     </value>
                  </element>
                  <element name="unit">
                     <value localId="416" locator="238:65-238:81" path="unit" xsi:type="Property">
                        <source localId="415" locator="238:65-238:76" name="doseQuantity" xsi:type="OperandRef"/>
                     </value>
                  </element>
               </then>
            </caseItem>
            <caseItem localId="450" locator="241:5-242:142">
               <when localId="433" locator="241:10-241:100" xsi:type="And">
                  <operand localId="422" locator="241:10-241:33" xsi:type="Equal">
                     <operand localId="420" locator="241:10-241:26" path="unit" xsi:type="Property">
                        <source localId="419" locator="241:10-241:21" name="doseQuantity" xsi:type="OperandRef"/>
                     </operand>
                     <operand localId="421" locator="241:30-241:33" valueType="t:String" value="mL" xsi:type="Literal"/>
                  </operand>
                  <operand localId="432" locator="241:39-241:100" xsi:type="Equal">
                     <operand localId="426" locator="241:40-241:71" xsi:type="PositionOf">
                        <pattern localId="423" locator="241:51-241:55" valueType="t:String" value="/mL" xsi:type="Literal"/>
                        <string localId="425" locator="241:58-241:70" path="unit" xsi:type="Property">
                           <source localId="424" locator="241:58-241:65" name="strength" xsi:type="OperandRef"/>
                        </string>
                     </operand>
                     <operand localId="431" locator="241:75-241:99" xsi:type="Subtract">
                        <operand localId="429" locator="241:75-241:95" xsi:type="Length">
                           <operand localId="428" locator="241:82-241:94" path="unit" xsi:type="Property">
                              <source localId="427" locator="241:82-241:89" name="strength" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="430" locator="241:99" valueType="t:Integer" value="3" xsi:type="Literal"/>
                     </operand>
                  </operand>
               </when>
               <then localId="449" locator="242:7-242:142" classType="t:Quantity" xsi:type="Instance">
                  <element name="value">
                     <value localId="440" locator="242:25-242:73" xsi:type="Multiply">
                        <operand localId="437" locator="242:25-242:56" xsi:type="Multiply">
                           <operand localId="434" locator="242:25-242:35" name="dosesPerDay" xsi:type="OperandRef"/>
                           <operand localId="436" locator="242:39-242:56" path="value" xsi:type="Property">
                              <source localId="435" locator="242:39-242:50" name="doseQuantity" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="439" locator="242:60-242:73" path="value" xsi:type="Property">
                           <source localId="438" locator="242:60-242:67" name="strength" xsi:type="OperandRef"/>
                        </operand>
                     </value>
                  </element>
                  <element name="unit">
                     <value localId="448" locator="242:82-242:140" xsi:type="Substring">
                        <stringToSub localId="442" locator="242:92-242:104" path="unit" xsi:type="Property">
                           <source localId="441" locator="242:92-242:99" name="strength" xsi:type="OperandRef"/>
                        </stringToSub>
                        <startIndex localId="443" locator="242:107" valueType="t:Integer" value="0" xsi:type="Literal"/>
                        <length localId="447" locator="242:110-242:139" xsi:type="PositionOf">
                           <pattern localId="444" locator="242:121-242:123" valueType="t:String" value="/" xsi:type="Literal"/>
                           <string localId="446" locator="242:126-242:138" path="unit" xsi:type="Property">
                              <source localId="445" locator="242:126-242:133" name="strength" xsi:type="OperandRef"/>
                           </string>
                        </length>
                     </value>
                  </element>
               </then>
            </caseItem>
            <else localId="466" locator="246:7-246:142" classType="t:Quantity" xsi:type="Instance">
               <element name="value">
                  <value localId="457" locator="246:25-246:73" xsi:type="Multiply">
                     <operand localId="454" locator="246:25-246:56" xsi:type="Multiply">
                        <operand localId="451" locator="246:25-246:35" name="dosesPerDay" xsi:type="OperandRef"/>
                        <operand localId="453" locator="246:39-246:56" path="value" xsi:type="Property">
                           <source localId="452" locator="246:39-246:50" name="doseQuantity" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                     <operand localId="456" locator="246:60-246:73" path="value" xsi:type="Property">
                        <source localId="455" locator="246:60-246:67" name="strength" xsi:type="OperandRef"/>
                     </operand>
                  </value>
               </element>
               <element name="unit">
                  <value localId="465" locator="246:82-246:140" xsi:type="Substring">
                     <stringToSub localId="459" locator="246:92-246:104" path="unit" xsi:type="Property">
                        <source localId="458" locator="246:92-246:99" name="strength" xsi:type="OperandRef"/>
                     </stringToSub>
                     <startIndex localId="460" locator="246:107" valueType="t:Integer" value="0" xsi:type="Literal"/>
                     <length localId="464" locator="246:110-246:139" xsi:type="PositionOf">
                        <pattern localId="461" locator="246:121-246:123" valueType="t:String" value="/" xsi:type="Literal"/>
                        <string localId="463" locator="246:126-246:138" path="unit" xsi:type="Property">
                           <source localId="462" locator="246:126-246:133" name="strength" xsi:type="OperandRef"/>
                        </string>
                     </length>
                  </value>
               </element>
            </else>
         </expression>
         <operand name="ingredientCode">
            <operandTypeSpecifier localId="380" locator="226:45-226:48" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="strength">
            <operandTypeSpecifier localId="381" locator="226:60-226:67" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="doseFormCode">
            <operandTypeSpecifier localId="382" locator="226:83-226:86" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="doseQuantity">
            <operandTypeSpecifier localId="383" locator="226:102-226:109" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="dosesPerDay">
            <operandTypeSpecifier localId="384" locator="226:124-226:130" name="t:Decimal" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="472" locator="249:1-250:20" name="GetMedicationName" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="472">
               <a:s>define function GetMedicationName(rxNormCode Code):
  </a:s>
               <a:s r="471">
                  <a:s r="471">
                     <a:s r="470">
                        <a:s>rxNormCode</a:s>
                     </a:s>
                     <a:s>.</a:s>
                     <a:s r="471">
                        <a:s>display</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="471" locator="250:3-250:20" path="display" xsi:type="Property">
            <source localId="470" locator="250:3-250:12" name="rxNormCode" xsi:type="OperandRef"/>
         </expression>
         <operand name="rxNormCode">
            <operandTypeSpecifier localId="469" locator="249:46-249:49" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="563" locator="258:1-275:5" name="GetDailyDoseDescription" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="563">
               <a:s>/*
  SingletonFrom([MED_DRUG: DRUG_RXCUI in rxNormCode]).DRUG_NAME
  */

/*
  Builds a description for the daily dose for an ingredient
*/
define function GetDailyDoseDescription(ingredientCode Code, ingredientName String, strength Quantity, doseFormCode Code, doseFormName String, doseQuantity Quantity, dosesPerDay Decimal, dailyDose Quantity):
  </a:s>
               <a:s r="562">
                  <a:s r="562">
                     <a:s>case
    /* if patch */
    </a:s>
                     <a:s r="509">
                        <a:s>when </a:s>
                        <a:s r="482">
                           <a:s>IsPatch(</a:s>
                           <a:s r="481">
                              <a:s>doseFormCode</a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                        <a:s> then
      /* buprenorphine or fentanyl patch */
      </a:s>
                        <a:s r="508">
                           <a:s>if </a:s>
                           <a:s r="489">
                              <a:s r="485">
                                 <a:s>ToInteger(</a:s>
                                 <a:s r="484">
                                    <a:s r="483">
                                       <a:s>ingredientCode</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="484">
                                       <a:s>code</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s> in </a:s>
                              <a:s r="488">
                                 <a:s r="486">{ 1819, 4337 }</a:s>
                              </a:s>
                           </a:s>
                           <a:s> then
        </a:s>
                           <a:s r="506">
                              <a:s r="503">
                                 <a:s r="501">
                                    <a:s r="498">
                                       <a:s r="496">
                                          <a:s r="492">
                                             <a:s r="490">
                                                <a:s>ingredientName</a:s>
                                             </a:s>
                                             <a:s> + </a:s>
                                             <a:s r="491">
                                                <a:s>' patch: '</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s> + </a:s>
                                          <a:s r="495">
                                             <a:s>ToString(</a:s>
                                             <a:s r="494">
                                                <a:s r="493">
                                                   <a:s>doseQuantity</a:s>
                                                </a:s>
                                                <a:s>.</a:s>
                                                <a:s r="494">
                                                   <a:s>value</a:s>
                                                </a:s>
                                             </a:s>
                                             <a:s>)</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> + </a:s>
                                       <a:s r="497">
                                          <a:s>' * '</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> + </a:s>
                                    <a:s r="500">
                                       <a:s>ToString(</a:s>
                                       <a:s r="499">
                                          <a:s>strength</a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> + </a:s>
                                 <a:s r="502">
                                    <a:s>' = '</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> + </a:s>
                              <a:s r="505">
                                 <a:s>ToString(</a:s>
                                 <a:s r="504">
                                    <a:s>dailyDose</a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s r="507">
      else
        null</a:s>
                        </a:s>
                     </a:s>
                     <a:s>

    /* if dose unit in actual mass units (mg or mcg -- when it's a single med) */
    </a:s>
                     <a:s r="536">
                        <a:s>when </a:s>
                        <a:s r="515">
                           <a:s r="511">
                              <a:s r="510">
                                 <a:s>doseQuantity</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="511">
                                 <a:s>unit</a:s>
                              </a:s>
                           </a:s>
                           <a:s> in </a:s>
                           <a:s r="514">
                              <a:s>{ </a:s>
                              <a:s r="512">
                                 <a:s>'mg'</a:s>
                              </a:s>
                              <a:s>, </a:s>
                              <a:s r="513">
                                 <a:s>'mcg'</a:s>
                              </a:s>
                              <a:s> }</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
      </a:s>
                        <a:s r="535">
                           <a:s r="532">
                              <a:s r="530">
                                 <a:s r="527">
                                    <a:s r="525">
                                       <a:s r="522">
                                          <a:s r="520">
                                             <a:s r="518">
                                                <a:s r="516">
                                                   <a:s>ingredientName</a:s>
                                                </a:s>
                                                <a:s> + </a:s>
                                                <a:s r="517">
                                                   <a:s>' '</a:s>
                                                </a:s>
                                             </a:s>
                                             <a:s> + </a:s>
                                             <a:s r="519">
                                                <a:s>doseFormName</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s> + </a:s>
                                          <a:s r="521">
                                             <a:s>': '</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> + </a:s>
                                       <a:s r="524">
                                          <a:s>ToString(</a:s>
                                          <a:s r="523">
                                             <a:s>dosesPerDay</a:s>
                                          </a:s>
                                          <a:s>)</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> + </a:s>
                                    <a:s r="526">
                                       <a:s>'/d * '</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> + </a:s>
                                 <a:s r="529">
                                    <a:s>ToString(</a:s>
                                    <a:s r="528">
                                       <a:s>doseQuantity</a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> + </a:s>
                              <a:s r="531">
                                 <a:s>' = '</a:s>
                              </a:s>
                           </a:s>
                           <a:s> + </a:s>
                           <a:s r="534">
                              <a:s>ToString(</a:s>
                              <a:s r="533">
                                 <a:s>dailyDose</a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>

    /* if doseQuantity in actual volume units (mL) or not in actual units (e.g. 1 tab, 1 spray) */
    else
      </a:s>
                     <a:s r="561">
                        <a:s r="558">
                           <a:s r="556">
                              <a:s r="553">
                                 <a:s r="551">
                                    <a:s r="548">
                                       <a:s r="546">
                                          <a:s r="543">
                                             <a:s r="541">
                                                <a:s r="539">
                                                   <a:s r="537">
                                                      <a:s>ingredientName</a:s>
                                                   </a:s>
                                                   <a:s> + </a:s>
                                                   <a:s r="538">
                                                      <a:s>' '</a:s>
                                                   </a:s>
                                                </a:s>
                                                <a:s> + </a:s>
                                                <a:s r="540">
                                                   <a:s>doseFormName</a:s>
                                                </a:s>
                                             </a:s>
                                             <a:s> + </a:s>
                                             <a:s r="542">
                                                <a:s>': '</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s> + </a:s>
                                          <a:s r="545">
                                             <a:s>ToString(</a:s>
                                             <a:s r="544">
                                                <a:s>dosesPerDay</a:s>
                                             </a:s>
                                             <a:s>)</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> + </a:s>
                                       <a:s r="547">
                                          <a:s>'/d * '</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> + </a:s>
                                    <a:s r="550">
                                       <a:s>ToString(</a:s>
                                       <a:s r="549">
                                          <a:s>doseQuantity</a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> + </a:s>
                                 <a:s r="552">
                                    <a:s>' * '</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> + </a:s>
                              <a:s r="555">
                                 <a:s>ToString(</a:s>
                                 <a:s r="554">
                                    <a:s>strength</a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                           <a:s> + </a:s>
                           <a:s r="557">
                              <a:s>' = '</a:s>
                           </a:s>
                        </a:s>
                        <a:s> + </a:s>
                        <a:s r="560">
                           <a:s>ToString(</a:s>
                           <a:s r="559">
                              <a:s>dailyDose</a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
  end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="562" locator="259:3-275:5" xsi:type="Case">
            <caseItem localId="509" locator="261:5-266:12">
               <when localId="482" locator="261:10-261:30" name="IsPatch" xsi:type="FunctionRef">
                  <operand localId="481" locator="261:18-261:29" name="doseFormCode" xsi:type="OperandRef"/>
               </when>
               <then localId="508" locator="263:7-266:12" xsi:type="If">
                  <condition localId="489" locator="263:10-263:57" xsi:type="In">
                     <operand localId="485" locator="263:10-263:39" xsi:type="ToInteger">
                        <operand localId="484" locator="263:20-263:38" path="code" xsi:type="Property">
                           <source localId="483" locator="263:20-263:33" name="ingredientCode" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                     <operand localId="488" locator="263:44-263:57" xsi:type="List">
                        <element localId="486" locator="263:46-263:49" valueType="t:Integer" value="1819" xsi:type="Literal"/>
                        <element localId="487" locator="263:52-263:55" valueType="t:Integer" value="4337" xsi:type="Literal"/>
                     </operand>
                  </condition>
                  <then localId="506" locator="264:9-264:125" xsi:type="Concatenate">
                     <operand localId="503" locator="264:9-264:103" xsi:type="Concatenate">
                        <operand localId="501" locator="264:9-264:95" xsi:type="Concatenate">
                           <operand localId="498" locator="264:9-264:74" xsi:type="Concatenate">
                              <operand localId="496" locator="264:9-264:66" xsi:type="Concatenate">
                                 <operand localId="492" locator="264:9-264:35" xsi:type="Concatenate">
                                    <operand localId="490" locator="264:9-264:22" name="ingredientName" xsi:type="OperandRef"/>
                                    <operand localId="491" locator="264:26-264:35" valueType="t:String" value=" patch: " xsi:type="Literal"/>
                                 </operand>
                                 <operand localId="495" locator="264:39-264:66" xsi:type="ToString">
                                    <operand localId="494" locator="264:48-264:65" path="value" xsi:type="Property">
                                       <source localId="493" locator="264:48-264:59" name="doseQuantity" xsi:type="OperandRef"/>
                                    </operand>
                                 </operand>
                              </operand>
                              <operand localId="497" locator="264:70-264:74" valueType="t:String" value=" * " xsi:type="Literal"/>
                           </operand>
                           <operand localId="500" locator="264:78-264:95" xsi:type="ToString">
                              <operand localId="499" locator="264:87-264:94" name="strength" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="502" locator="264:99-264:103" valueType="t:String" value=" = " xsi:type="Literal"/>
                     </operand>
                     <operand localId="505" locator="264:107-264:125" xsi:type="ToString">
                        <operand localId="504" locator="264:116-264:124" name="dailyDose" xsi:type="OperandRef"/>
                     </operand>
                  </then>
                  <else asType="t:String" xsi:type="As">
                     <operand localId="507" locator="266:9-266:12" xsi:type="Null"/>
                  </else>
               </then>
            </caseItem>
            <caseItem localId="536" locator="269:5-270:137">
               <when localId="515" locator="269:10-269:45" xsi:type="In">
                  <operand localId="511" locator="269:10-269:26" path="unit" xsi:type="Property">
                     <source localId="510" locator="269:10-269:21" name="doseQuantity" xsi:type="OperandRef"/>
                  </operand>
                  <operand localId="514" locator="269:31-269:45" xsi:type="List">
                     <element localId="512" locator="269:33-269:36" valueType="t:String" value="mg" xsi:type="Literal"/>
                     <element localId="513" locator="269:39-269:43" valueType="t:String" value="mcg" xsi:type="Literal"/>
                  </operand>
               </when>
               <then localId="535" locator="270:7-270:137" xsi:type="Concatenate">
                  <operand localId="532" locator="270:7-270:115" xsi:type="Concatenate">
                     <operand localId="530" locator="270:7-270:107" xsi:type="Concatenate">
                        <operand localId="527" locator="270:7-270:82" xsi:type="Concatenate">
                           <operand localId="525" locator="270:7-270:72" xsi:type="Concatenate">
                              <operand localId="522" locator="270:7-270:48" xsi:type="Concatenate">
                                 <operand localId="520" locator="270:7-270:41" xsi:type="Concatenate">
                                    <operand localId="518" locator="270:7-270:26" xsi:type="Concatenate">
                                       <operand localId="516" locator="270:7-270:20" name="ingredientName" xsi:type="OperandRef"/>
                                       <operand localId="517" locator="270:24-270:26" valueType="t:String" value=" " xsi:type="Literal"/>
                                    </operand>
                                    <operand localId="519" locator="270:30-270:41" name="doseFormName" xsi:type="OperandRef"/>
                                 </operand>
                                 <operand localId="521" locator="270:45-270:48" valueType="t:String" value=": " xsi:type="Literal"/>
                              </operand>
                              <operand localId="524" locator="270:52-270:72" xsi:type="ToString">
                                 <operand localId="523" locator="270:61-270:71" name="dosesPerDay" xsi:type="OperandRef"/>
                              </operand>
                           </operand>
                           <operand localId="526" locator="270:76-270:82" valueType="t:String" value="/d * " xsi:type="Literal"/>
                        </operand>
                        <operand localId="529" locator="270:86-270:107" xsi:type="ToString">
                           <operand localId="528" locator="270:95-270:106" name="doseQuantity" xsi:type="OperandRef"/>
                        </operand>
                     </operand>
                     <operand localId="531" locator="270:111-270:115" valueType="t:String" value=" = " xsi:type="Literal"/>
                  </operand>
                  <operand localId="534" locator="270:119-270:137" xsi:type="ToString">
                     <operand localId="533" locator="270:128-270:136" name="dailyDose" xsi:type="OperandRef"/>
                  </operand>
               </then>
            </caseItem>
            <else localId="561" locator="274:7-274:166" xsi:type="Concatenate">
               <operand localId="558" locator="274:7-274:144" xsi:type="Concatenate">
                  <operand localId="556" locator="274:7-274:136" xsi:type="Concatenate">
                     <operand localId="553" locator="274:7-274:115" xsi:type="Concatenate">
                        <operand localId="551" locator="274:7-274:107" xsi:type="Concatenate">
                           <operand localId="548" locator="274:7-274:82" xsi:type="Concatenate">
                              <operand localId="546" locator="274:7-274:72" xsi:type="Concatenate">
                                 <operand localId="543" locator="274:7-274:48" xsi:type="Concatenate">
                                    <operand localId="541" locator="274:7-274:41" xsi:type="Concatenate">
                                       <operand localId="539" locator="274:7-274:26" xsi:type="Concatenate">
                                          <operand localId="537" locator="274:7-274:20" name="ingredientName" xsi:type="OperandRef"/>
                                          <operand localId="538" locator="274:24-274:26" valueType="t:String" value=" " xsi:type="Literal"/>
                                       </operand>
                                       <operand localId="540" locator="274:30-274:41" name="doseFormName" xsi:type="OperandRef"/>
                                    </operand>
                                    <operand localId="542" locator="274:45-274:48" valueType="t:String" value=": " xsi:type="Literal"/>
                                 </operand>
                                 <operand localId="545" locator="274:52-274:72" xsi:type="ToString">
                                    <operand localId="544" locator="274:61-274:71" name="dosesPerDay" xsi:type="OperandRef"/>
                                 </operand>
                              </operand>
                              <operand localId="547" locator="274:76-274:82" valueType="t:String" value="/d * " xsi:type="Literal"/>
                           </operand>
                           <operand localId="550" locator="274:86-274:107" xsi:type="ToString">
                              <operand localId="549" locator="274:95-274:106" name="doseQuantity" xsi:type="OperandRef"/>
                           </operand>
                        </operand>
                        <operand localId="552" locator="274:111-274:115" valueType="t:String" value=" * " xsi:type="Literal"/>
                     </operand>
                     <operand localId="555" locator="274:119-274:136" xsi:type="ToString">
                        <operand localId="554" locator="274:128-274:135" name="strength" xsi:type="OperandRef"/>
                     </operand>
                  </operand>
                  <operand localId="557" locator="274:140-274:144" valueType="t:String" value=" = " xsi:type="Literal"/>
               </operand>
               <operand localId="560" locator="274:148-274:166" xsi:type="ToString">
                  <operand localId="559" locator="274:157-274:165" name="dailyDose" xsi:type="OperandRef"/>
               </operand>
            </else>
         </expression>
         <operand name="ingredientCode">
            <operandTypeSpecifier localId="473" locator="258:56-258:59" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="ingredientName">
            <operandTypeSpecifier localId="474" locator="258:77-258:82" name="t:String" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="strength">
            <operandTypeSpecifier localId="475" locator="258:94-258:101" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="doseFormCode">
            <operandTypeSpecifier localId="476" locator="258:117-258:120" name="t:Code" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="doseFormName">
            <operandTypeSpecifier localId="477" locator="258:136-258:141" name="t:String" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="doseQuantity">
            <operandTypeSpecifier localId="478" locator="258:157-258:164" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="dosesPerDay">
            <operandTypeSpecifier localId="479" locator="258:179-258:185" name="t:Decimal" xsi:type="NamedTypeSpecifier"/>
         </operand>
         <operand name="dailyDose">
            <operandTypeSpecifier localId="480" locator="258:198-258:205" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="647" locator="295:1-321:3" name="CalculateMMEs" context="Unfiltered" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="647">
               <a:s>/*
  Calculates MMEs for the given input prescription information and returns it
  as a list of tuples:

  List&lt;Tuple {
    rxNormCode Code,
    doseFormCode Code,
    doseQuantity Quantity,
    dosesPerDay Decimal,
    ingredientCode Code,
    ingredientName String,
    strength Quantity,
    dailyDose Quantity,
    dailyDoseDescription String,
    conversionFactor Decimal,
    mme Quantity
  }>
*/
define function CalculateMMEs(medications List&lt;Tuple { rxNormCode Code, doseQuantity Quantity, dosesPerDay Decimal }>):
  </a:s>
               <a:s r="646">
                  <a:s r="646">
                     <a:s>Flatten(
    </a:s>
                     <a:s r="645">
                        <a:s>
                           <a:s r="573">
                              <a:s r="572">
                                 <a:s>
                                    <a:s>medications</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> M</a:s>
                           </a:s>
                        </a:s>
                        <a:s>
      </a:s>
                        <a:s>
                           <a:s>let </a:s>
                           <a:s r="577">
                              <a:s>Ingredients: </a:s>
                              <a:s r="576">
                                 <a:s>GetIngredients(</a:s>
                                 <a:s r="575">
                                    <a:s r="574">
                                       <a:s>M</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="575">
                                       <a:s>rxNormCode</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>
      </a:s>
                        <a:s r="644">
                           <a:s>return
        </a:s>
                           <a:s r="643">
                              <a:s>
                                 <a:s r="579">
                                    <a:s r="578">
                                       <a:s>
                                          <a:s>Ingredients</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> I</a:s>
                                 </a:s>
                              </a:s>
                              <a:s>
          </a:s>
                              <a:s>
                                 <a:s>let
            </a:s>
                                 <a:s r="583">
                                    <a:s>adjustedDoseQuantity: </a:s>
                                    <a:s r="582">
                                       <a:s>EnsureMicrogramQuantity(</a:s>
                                       <a:s r="581">
                                          <a:s r="580">
                                             <a:s>M</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="581">
                                             <a:s>doseQuantity</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>,
            </a:s>
                                 <a:s r="594">
                                    <a:s>dailyDose: </a:s>
                                    <a:s r="593">
                                       <a:s>GetDailyDose(</a:s>
                                       <a:s r="585">
                                          <a:s r="584">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="585">
                                             <a:s>ingredientCode</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="587">
                                          <a:s r="586">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="587">
                                             <a:s>strength</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="589">
                                          <a:s r="588">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="589">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="590">
                                          <a:s>adjustedDoseQuantity</a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="592">
                                          <a:s r="591">
                                             <a:s>M</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="592">
                                             <a:s>dosesPerDay</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>,
            </a:s>
                                 <a:s r="601">
                                    <a:s>factor: </a:s>
                                    <a:s r="600">
                                       <a:s>GetConversionFactor(</a:s>
                                       <a:s r="596">
                                          <a:s r="595">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="596">
                                             <a:s>ingredientCode</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="597">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="599">
                                          <a:s r="598">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="599">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>
          </a:s>
                              <a:s r="642">
                                 <a:s>return </a:s>
                                 <a:s r="641">
                                    <a:s>{
            </a:s>
                                    <a:s>
                                       <a:s>rxNormCode: </a:s>
                                       <a:s r="603">
                                          <a:s r="602">
                                             <a:s>M</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="603">
                                             <a:s>rxNormCode</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>doseFormCode: </a:s>
                                       <a:s r="605">
                                          <a:s r="604">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="605">
                                             <a:s>doseFormCode</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>doseQuantity: </a:s>
                                       <a:s r="606">
                                          <a:s>adjustedDoseQuantity</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>dosesPerDay: </a:s>
                                       <a:s r="608">
                                          <a:s r="607">
                                             <a:s>M</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="608">
                                             <a:s>dosesPerDay</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>ingredientCode: </a:s>
                                       <a:s r="610">
                                          <a:s r="609">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="610">
                                             <a:s>ingredientCode</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>ingredientName: </a:s>
                                       <a:s r="612">
                                          <a:s r="611">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="612">
                                             <a:s>ingredientName</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>strength: </a:s>
                                       <a:s r="614">
                                          <a:s r="613">
                                             <a:s>I</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="614">
                                             <a:s>strength</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>dailyDose: </a:s>
                                       <a:s r="615">
                                          <a:s>dailyDose</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>dailyDoseDescription: </a:s>
                                       <a:s r="630">
                                          <a:s>GetDailyDoseDescription(</a:s>
                                          <a:s r="617">
                                             <a:s r="616">
                                                <a:s>I</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="617">
                                                <a:s>ingredientCode</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="619">
                                             <a:s r="618">
                                                <a:s>I</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="619">
                                                <a:s>ingredientName</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="621">
                                             <a:s r="620">
                                                <a:s>I</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="621">
                                                <a:s>strength</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="623">
                                             <a:s r="622">
                                                <a:s>I</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="623">
                                                <a:s>doseFormCode</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="625">
                                             <a:s r="624">
                                                <a:s>I</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="625">
                                                <a:s>doseFormName</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="626">
                                             <a:s>adjustedDoseQuantity</a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="628">
                                             <a:s r="627">
                                                <a:s>M</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="628">
                                                <a:s>dosesPerDay</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="629">
                                             <a:s>dailyDose</a:s>
                                          </a:s>
                                          <a:s>)</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>conversionFactor: </a:s>
                                       <a:s r="631">
                                          <a:s>factor</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>,
            </a:s>
                                    <a:s>
                                       <a:s>mme: </a:s>
                                       <a:s r="640">
                                          <a:s>Quantity {
              </a:s>
                                          <a:s>
                                             <a:s>value: </a:s>
                                             <a:s r="635">
                                                <a:s r="633">
                                                   <a:s r="632">
                                                      <a:s>dailyDose</a:s>
                                                   </a:s>
                                                   <a:s>.</a:s>
                                                   <a:s r="633">
                                                      <a:s>value</a:s>
                                                   </a:s>
                                                </a:s>
                                                <a:s> * </a:s>
                                                <a:s r="634">
                                                   <a:s>factor</a:s>
                                                </a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>,
              </a:s>
                                          <a:s>
                                             <a:s>unit: </a:s>
                                             <a:s r="639">
                                                <a:s r="637">
                                                   <a:s r="636">
                                                      <a:s>dailyDose</a:s>
                                                   </a:s>
                                                   <a:s>.</a:s>
                                                   <a:s r="637">
                                                      <a:s>unit</a:s>
                                                   </a:s>
                                                </a:s>
                                                <a:s> + </a:s>
                                                <a:s r="638">
                                                   <a:s>'/d'</a:s>
                                                </a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>
            }</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>
          }</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
  )</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="646" locator="296:3-321:3" xsi:type="Flatten">
            <operand localId="645" locator="297:5-320:11" xsi:type="Query">
               <source localId="573" locator="297:5-297:17" alias="M">
                  <expression localId="572" locator="297:5-297:15" name="medications" xsi:type="OperandRef"/>
               </source>
               <let localId="577" locator="298:11-298:51" identifier="Ingredients">
                  <expression localId="576" locator="298:24-298:51" name="GetIngredients" xsi:type="FunctionRef">
                     <operand localId="575" locator="298:39-298:50" path="rxNormCode" scope="M" xsi:type="Property"/>
                  </expression>
               </let>
               <return localId="644" locator="299:7-320:11">
                  <expression localId="643" locator="300:9-320:11" xsi:type="Query">
                     <source localId="579" locator="300:9-300:21" alias="I">
                        <expression localId="578" locator="300:9-300:19" name="Ingredients" xsi:type="QueryLetRef"/>
                     </source>
                     <let localId="583" locator="302:13-302:73" identifier="adjustedDoseQuantity">
                        <expression localId="582" locator="302:35-302:73" name="EnsureMicrogramQuantity" xsi:type="FunctionRef">
                           <operand localId="581" locator="302:59-302:72" path="doseQuantity" scope="M" xsi:type="Property"/>
                        </expression>
                     </let>
                     <let localId="594" locator="303:13-303:118" identifier="dailyDose">
                        <expression localId="593" locator="303:24-303:118" name="GetDailyDose" xsi:type="FunctionRef">
                           <operand localId="585" locator="303:37-303:52" path="ingredientCode" scope="I" xsi:type="Property"/>
                           <operand localId="587" locator="303:55-303:64" path="strength" scope="I" xsi:type="Property"/>
                           <operand localId="589" locator="303:67-303:80" path="doseFormCode" scope="I" xsi:type="Property"/>
                           <operand localId="590" locator="303:83-303:102" name="adjustedDoseQuantity" xsi:type="QueryLetRef"/>
                           <operand localId="592" locator="303:105-303:117" path="dosesPerDay" scope="M" xsi:type="Property"/>
                        </expression>
                     </let>
                     <let localId="601" locator="304:13-304:84" identifier="factor">
                        <expression localId="600" locator="304:21-304:84" name="GetConversionFactor" xsi:type="FunctionRef">
                           <operand localId="596" locator="304:41-304:56" path="ingredientCode" scope="I" xsi:type="Property"/>
                           <operand localId="597" locator="304:59-304:67" name="dailyDose" xsi:type="QueryLetRef"/>
                           <operand localId="599" locator="304:70-304:83" path="doseFormCode" scope="I" xsi:type="Property"/>
                        </expression>
                     </let>
                     <return localId="642" locator="305:11-320:11">
                        <expression localId="641" locator="305:18-320:11" xsi:type="Tuple">
                           <element name="rxNormCode">
                              <value localId="603" locator="306:25-306:36" path="rxNormCode" scope="M" xsi:type="Property"/>
                           </element>
                           <element name="doseFormCode">
                              <value localId="605" locator="307:27-307:40" path="doseFormCode" scope="I" xsi:type="Property"/>
                           </element>
                           <element name="doseQuantity">
                              <value localId="606" locator="308:27-308:46" name="adjustedDoseQuantity" xsi:type="QueryLetRef"/>
                           </element>
                           <element name="dosesPerDay">
                              <value localId="608" locator="309:26-309:38" path="dosesPerDay" scope="M" xsi:type="Property"/>
                           </element>
                           <element name="ingredientCode">
                              <value localId="610" locator="310:29-310:44" path="ingredientCode" scope="I" xsi:type="Property"/>
                           </element>
                           <element name="ingredientName">
                              <value localId="612" locator="311:29-311:44" path="ingredientName" scope="I" xsi:type="Property"/>
                           </element>
                           <element name="strength">
                              <value localId="614" locator="312:23-312:32" path="strength" scope="I" xsi:type="Property"/>
                           </element>
                           <element name="dailyDose">
                              <value localId="615" locator="313:24-313:32" name="dailyDose" xsi:type="QueryLetRef"/>
                           </element>
                           <element name="dailyDoseDescription">
                              <value localId="630" locator="314:35-314:185" name="GetDailyDoseDescription" xsi:type="FunctionRef">
                                 <operand localId="617" locator="314:59-314:74" path="ingredientCode" scope="I" xsi:type="Property"/>
                                 <operand localId="619" locator="314:77-314:92" path="ingredientName" scope="I" xsi:type="Property"/>
                                 <operand localId="621" locator="314:95-314:104" path="strength" scope="I" xsi:type="Property"/>
                                 <operand localId="623" locator="314:107-314:120" path="doseFormCode" scope="I" xsi:type="Property"/>
                                 <operand localId="625" locator="314:123-314:136" path="doseFormName" scope="I" xsi:type="Property"/>
                                 <operand localId="626" locator="314:139-314:158" name="adjustedDoseQuantity" xsi:type="QueryLetRef"/>
                                 <operand localId="628" locator="314:161-314:173" path="dosesPerDay" scope="M" xsi:type="Property"/>
                                 <operand localId="629" locator="314:176-314:184" name="dailyDose" xsi:type="QueryLetRef"/>
                              </value>
                           </element>
                           <element name="conversionFactor">
                              <value localId="631" locator="315:31-315:36" name="factor" xsi:type="QueryLetRef"/>
                           </element>
                           <element name="mme">
                              <value localId="640" locator="316:18-319:13" classType="t:Quantity" xsi:type="Instance">
                                 <element name="value">
                                    <value localId="635" locator="317:22-317:45" xsi:type="Multiply">
                                       <operand localId="633" locator="317:22-317:36" path="value" xsi:type="Property">
                                          <source localId="632" locator="317:22-317:30" name="dailyDose" xsi:type="QueryLetRef"/>
                                       </operand>
                                       <operand localId="634" locator="317:40-317:45" name="factor" xsi:type="QueryLetRef"/>
                                    </value>
                                 </element>
                                 <element name="unit">
                                    <value localId="639" locator="318:21-318:41" xsi:type="Concatenate">
                                       <operand localId="637" locator="318:21-318:34" path="unit" xsi:type="Property">
                                          <source localId="636" locator="318:21-318:29" name="dailyDose" xsi:type="QueryLetRef"/>
                                       </operand>
                                       <operand localId="638" locator="318:38-318:41" valueType="t:String" value="/d" xsi:type="Literal"/>
                                    </value>
                                 </element>
                              </value>
                           </element>
                        </expression>
                     </return>
                  </expression>
               </return>
            </operand>
         </expression>
         <operand name="medications">
            <operandTypeSpecifier localId="571" locator="295:43-295:117" xsi:type="ListTypeSpecifier">
               <elementType localId="570" locator="295:48-295:116" xsi:type="TupleTypeSpecifier">
                  <element localId="565" locator="295:56-295:70" name="rxNormCode">
                     <elementType localId="564" locator="295:67-295:70" name="t:Code" xsi:type="NamedTypeSpecifier"/>
                  </element>
                  <element localId="567" locator="295:73-295:93" name="doseQuantity">
                     <elementType localId="566" locator="295:86-295:93" name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                  </element>
                  <element localId="569" locator="295:96-295:114" name="dosesPerDay">
                     <elementType localId="568" locator="295:108-295:114" name="t:Decimal" xsi:type="NamedTypeSpecifier"/>
                  </element>
               </elementType>
            </operandTypeSpecifier>
         </operand>
      </def>
   </statements>
</library>
